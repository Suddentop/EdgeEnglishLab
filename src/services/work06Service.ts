/**
 * Work_06 (ë¬¸ì¥ ìœ„ì¹˜ ì°¾ê¸°) ë¬¸ì œ ìƒì„± ë¡œì§
 * ì›ë³¸: src/components/work/Work_06_SentencePosition/Work_06_SentencePosition.tsx
 * 
 * ì´ íŒŒì¼ì€ ì›ë³¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¬¸ì œ ìƒì„± ë¡œì§ë§Œ ì¶”ì¶œí•œ ê²ƒì…ë‹ˆë‹¤.
 * ì›ë³¸ íŒŒì¼ì€ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ìœ¼ë©°, ë¡œì§ì„ ë³µì‚¬í•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */

import { callOpenAI, translateToKorean, addVarietyToPrompt, getProblemGenerationTemperature } from './common';

/**
 * ë¬¸ì¥ ìœ„ì¹˜ ì°¾ê¸° ë¬¸ì œ íƒ€ì… ì •ì˜
 */
export interface SentencePositionQuiz {
  id?: string; // ë‹¤ì¤‘ ì…ë ¥ ì²˜ë¦¬ë¥¼ ìœ„í•œ ID
  missingSentence: string;
  numberedPassage: string;
  answerIndex: number; // 0~4 (â‘ ~â‘¤)
  translation: string;
}

/**
 * ìœ í˜•#06: ë¬¸ì¥ ìœ„ì¹˜ ì°¾ê¸° ë¬¸ì œ ìƒì„±
 * @param passage - ì˜ì–´ ë³¸ë¬¸
 * @param previouslySelectedSentences - ì´ì „ì— ì„ íƒëœ ë¬¸ì¥ ëª©ë¡ (ë™ì¼ ë³¸ë¬¸ìœ¼ë¡œ ì—¬ëŸ¬ ë²ˆ ìƒì„± ì‹œ ì‚¬ìš©)
 * @returns ë¬¸ì¥ ìœ„ì¹˜ ì°¾ê¸° ë¬¸ì œ ë°ì´í„°
 */
export async function generateWork06Quiz(
  passage: string,
  previouslySelectedSentences?: string[]
): Promise<SentencePositionQuiz> {
  console.log('ğŸ” Work_06 ë¬¸ì œ ìƒì„± ì‹œì‘...');
  console.log('ğŸ“ ì…ë ¥ í…ìŠ¤íŠ¸ ê¸¸ì´:', passage.length);

  try {
    const prompt = `ì•„ë˜ ì˜ì–´ ë³¸ë¬¸ì„ ì½ê³ , **ëŒ€í•œë¯¼êµ­ ê³ ë“±í•™êµ êµìœ¡ê³¼ì • ìˆ˜í•™ëŠ¥ë ¥í‰ê°€(ìˆ˜ëŠ¥) ìˆ˜ì¤€**ì˜ ë¬¸ì¥ ìœ„ì¹˜ ì°¾ê¸° ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ê¸€ì˜ ì£¼ì œì™€ ê°€ì¥ ë°€ì ‘í•œ, ì˜ë¯¸ ìˆëŠ” ë¬¸ì¥ 1ê°œë¥¼ ì„ ì •í•˜ë˜, **ìˆ˜ëŠ¥ ìˆ˜ì¤€ì˜ ë¬¸ë§¥ ì´í•´ê°€ í•„ìš”í•œ í•µì‹¬ ë¬¸ì¥**ì„ ì„ íƒí•˜ì„¸ìš”.

**ì ˆëŒ€ ì§€ì¼œì•¼ í•  ê·œì¹™ (ìœ„ë°˜ ì‹œ ì˜¤ë¥˜):**
1. ë³¸ë¬¸ì„ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í• í•  ë•Œ, ì •í™•íˆ 5ê°œì˜ ìœ„ì¹˜ì—ë§Œ ì›ë¬¸ìë¥¼ ì‚½ì…
2. ì›ë¬¸ìëŠ” ë°˜ë“œì‹œ â‘ , â‘¡, â‘¢, â‘£, â‘¤ ìˆœì„œëŒ€ë¡œ ì‚¬ìš© (ì¤‘ë³µ ì—†ìŒ, â‘¥ ì´ìƒ ì‚¬ìš© ê¸ˆì§€)
3. ë¹ ì§„ ë¬¸ì¥ì´ ë“¤ì–´ê°ˆ ìœ„ì¹˜ëŠ” 1~5 ì¤‘ í•˜ë‚˜ë¡œ ì§€ì • (answerIndexëŠ” 0~4)
4. **ì ˆëŒ€ ê¸ˆì§€**: ë³¸ë¬¸ì— "ì •ë‹µìœ„ì¹˜", "ì •ë‹µ", "(ì •ë‹µ: X)", "[ì •ë‹µ ìœ„ì¹˜: X]", "[ì •ë‹µ ìœ„ì¹˜]", "ì •ë‹µ ìœ„ì¹˜", "ìœ„ì¹˜", "ì •ë‹µì€", "ì •ë‹µì´", "ì •ë‹µì„" ê°™ì€ í…ìŠ¤íŠ¸ë¥¼ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ ê²ƒ
5. ê° ì›ë¬¸ìëŠ” ë¬¸ì¥ ì•ì— ì‚½ì…
6. ì›ë¬¸ì ë’¤ì—ëŠ” ë°˜ë“œì‹œ ê³µë°±ì´ ìˆì–´ì•¼ í•¨
7. â‘¥, â‘¦, â‘§, â‘¨, â‘© ë“±ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ
8. ë³¸ë¬¸ì—ëŠ” ì˜ì–´ ë¬¸ì¥ë§Œ í¬í•¨í•˜ê³ , ì •ë‹µ ê´€ë ¨ í•œê¸€ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ ê²ƒ
9. ì›ë³¸ ë³¸ë¬¸ì— ì—†ë˜ í…ìŠ¤íŠ¸ëŠ” ì ˆëŒ€ ì¶”ê°€í•˜ì§€ ë§ ê²ƒ
10. **ì¤‘ìš”**: numberedPassage í•„ë“œì—ëŠ” ì˜¤ì§ ì˜ì–´ ë¬¸ì¥ê³¼ ì›ë¬¸ì(â‘ ~â‘¤)ë§Œ í¬í•¨í•˜ê³ , ê·¸ ì™¸ì˜ ëª¨ë“  í…ìŠ¤íŠ¸ëŠ” ì œì™¸
11. **ì ˆëŒ€ ê¸ˆì§€**: [1], [2], [3], (1), (2), (3), {1}, {2}, {3} ë“± ëª¨ë“  ìˆ«ì ë§ˆì»¤ ì‚¬ìš© ê¸ˆì§€
12. **ì ˆëŒ€ ê¸ˆì§€**: ì›ë¬¸ì ì¤‘ë³µ ì‚¬ìš© ê¸ˆì§€ (â‘ , â‘¡, â‘¢, â‘£, â‘¤ ê°ê° í•œ ë²ˆì”©ë§Œ ì‚¬ìš©)

**ì‘ì—… ìˆœì„œ:**
${previouslySelectedSentences && previouslySelectedSentences.length > 0 ? `
**âš ï¸ ë§¤ìš° ì¤‘ìš” - ì´ì „ ì„ íƒ ë¬¸ì¥ ì œì™¸:**
* ì•„ë˜ ë¬¸ì¥ë“¤ì€ ì´ì „ì— ì´ë¯¸ ì„ íƒëœ ë¬¸ì¥ì…ë‹ˆë‹¤. ì´ ë¬¸ì¥ë“¤ì€ **ì ˆëŒ€ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”**:
* ${previouslySelectedSentences.map(sentence => `"${sentence.substring(0, 100)}${sentence.length > 100 ? '...' : ''}"`).join(', ')}
* ìœ„ ë¬¸ì¥ë“¤ê³¼ëŠ” **ì™„ì „íˆ ë‹¤ë¥¸ ë¬¸ì¥**ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
* ë³¸ë¬¸ì—ì„œ ìœ„ ë¬¸ì¥ë“¤ì„ ì œì™¸í•œ ë‹¤ë¥¸ ì ì ˆí•œ ë¬¸ì¥ì„ ì„ íƒí•˜ì„¸ìš”.

` : ''}1. ë³¸ë¬¸ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ì£¼ì œ ë¬¸ì¥ 1ê°œë¥¼ ì„ ì •í•˜ì—¬ ì œê±° (ì´ê²ƒì´ missingSentence)
2. ë‚¨ì€ ë³¸ë¬¸ì„ ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„í•  (ë§ˆì¹¨í‘œ, ëŠë‚Œí‘œ, ë¬¼ìŒí‘œ ê¸°ì¤€)
3. ì²˜ìŒ 5ê°œ ë¬¸ì¥ ì•ì— â‘ ~â‘¤ë¥¼ ìˆœì„œëŒ€ë¡œ ì‚½ì… (ì¤‘ë³µ ì—†ì´) (ì´ê²ƒì´ numberedPassage)
4. ë¹ ì§„ ë¬¸ì¥ì´ ë“¤ì–´ê°ˆ ìœ„ì¹˜ë¥¼ 1~5 ì¤‘ í•˜ë‚˜ë¡œ ê²°ì • (answerIndex: 0~4)
5. **ì¤‘ìš”**: translation í•„ë“œì—ëŠ” ì›ë³¸ ë³¸ë¬¸(ì£¼ìš”ë¬¸ì¥ì´ ë¹ ì§€ê¸° ì „ ì›ë³¸ ë³¸ë¬¸)ì˜ í•œêµ­ì–´ í•´ì„ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.

**translation í•„ë“œ ê·œì¹™ (ì ˆëŒ€ í•„ìˆ˜, ìœ„ë°˜ ì‹œ ì˜¤ë¥˜):**
- âš ï¸ translationì€ ë°˜ë“œì‹œ ì›ë³¸ ë³¸ë¬¸(ì£¼ìš”ë¬¸ì¥ì„ ì›ë˜ì˜ ìœ„ì¹˜ì— í¬í•¨í•œ ì „ì²´ ì˜ì–´ ë³¸ë¬¸)ì˜ í•œêµ­ì–´ í•´ì„ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
- âš ï¸ ì ˆëŒ€ë¡œ ì›ë¬¸ì(â‘ , â‘¡, â‘¢, â‘£, â‘¤)ë¥¼ í¬í•¨í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.
- âš ï¸ ì ˆëŒ€ë¡œ numberedPassageì˜ ë²ˆì—­ì´ ì•„ë‹™ë‹ˆë‹¤. ì›ë³¸ ë³¸ë¬¸(passage)ì˜ ë²ˆì—­ì…ë‹ˆë‹¤.
- âš ï¸ missingSentenceê°€ ì›ë˜ ìœ„ì¹˜ì— í¬í•¨ëœ ìƒíƒœì˜ ì „ì²´ ë³¸ë¬¸ì„ í•œêµ­ì–´ë¡œ ë²ˆì—­í•œ ê²ƒì…ë‹ˆë‹¤.
- âš ï¸ ê° ë³¸ë¬¸ë§ˆë‹¤ ì›ë³¸ì´ ë‹¤ë¥´ë¯€ë¡œ, translationë„ ê° ë³¸ë¬¸ì˜ ì›ë³¸ì— ë§ëŠ” ê³ ìœ í•œ í•´ì„ì´ì–´ì•¼ í•©ë‹ˆë‹¤.

**ì •í™•í•œ ì˜ˆì‹œ:**
ì›ë³¸ ë³¸ë¬¸ì´ ë‹¤ìŒê³¼ ê°™ë‹¤ë©´:
"The main topic sentence that was removed. First sentence. Second sentence. Third sentence. Fourth sentence. Fifth sentence. Additional sentences."

{
  "missingSentence": "The main topic sentence that was removed.",
  "numberedPassage": "â‘  First sentence. â‘¡ Second sentence. â‘¢ Third sentence. â‘£ Fourth sentence. â‘¤ Fifth sentence. Additional sentences.",
  "answerIndex": 2,
  "translation": "ì œê±°ëœ ì£¼ì œ ë¬¸ì¥ì´ ì—¬ê¸°ì— ìˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ë¬¸ì¥. ë‘ ë²ˆì§¸ ë¬¸ì¥. ì„¸ ë²ˆì§¸ ë¬¸ì¥. ë„¤ ë²ˆì§¸ ë¬¸ì¥. ë‹¤ì„¯ ë²ˆì§¸ ë¬¸ì¥. ì¶”ê°€ ë¬¸ì¥ë“¤."
}

**ì ˆëŒ€ ê¸ˆì§€ì‚¬í•­ (ìœ„ë°˜ ì‹œ ì˜¤ë¥˜):**
- ë³¸ë¬¸ì— "[ì •ë‹µ ìœ„ì¹˜: X]" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "[ì •ë‹µ ìœ„ì¹˜]" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "ì •ë‹µ ìœ„ì¹˜(X)" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "ì •ë‹µ ìœ„ì¹˜ X" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "ì •ë‹µ(X)" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "ì •ë‹µ X" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "ìœ„ì¹˜(X)" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "ìœ„ì¹˜ X" í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "ì •ë‹µ" ë˜ëŠ” "ìœ„ì¹˜" ê´€ë ¨ í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "[1]", "[2]", "[3]" ë“± ìˆ«ìë§Œ ìˆëŠ” ëŒ€ê´„í˜¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "(1)", "(2)", "(3)" ë“± ìˆ«ìë§Œ ìˆëŠ” ê´„í˜¸ í¬í•¨ ê¸ˆì§€
- ë³¸ë¬¸ì— "{1}", "{2}", "{3}" ë“± ìˆ«ìë§Œ ìˆëŠ” ì¤‘ê´„í˜¸ í¬í•¨ ê¸ˆì§€
- â‘¥ ì´ìƒì˜ ì›ë¬¸ì ì‚¬ìš© ê¸ˆì§€
- ì›ë¬¸ì ì¤‘ë³µ ì‚¬ìš© ê¸ˆì§€ (â‘ , â‘¡, â‘¢, â‘£, â‘¤ ê°ê° í•œ ë²ˆì”©ë§Œ)
- ë³¸ë¬¸ì— í•œê¸€ í…ìŠ¤íŠ¸ í¬í•¨ ê¸ˆì§€ (ì˜ì–´ë§Œ)
- ë³¸ë¬¸ì— íŠ¹ìˆ˜ ê¸°í˜¸ë‚˜ ìˆ«ì ë§ˆì»¤ í¬í•¨ ê¸ˆì§€
- ì›ë³¸ ë³¸ë¬¸ì— ì—†ë˜ í…ìŠ¤íŠ¸ ì¶”ê°€ ê¸ˆì§€

**ì…ë ¥ ë³¸ë¬¸:**
${passage}`;

    // ë‹¤ì–‘ì„± ì¶”ê°€
    const enhancedPrompt = addVarietyToPrompt(prompt);
    const temperature = getProblemGenerationTemperature(0.7);

    const response = await callOpenAI({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: enhancedPrompt }],
      max_tokens: 2000,
      temperature: temperature
    });

    if (!response.ok) {
      throw new Error(`OpenAI API ì˜¤ë¥˜: ${response.status}`);
    }

    const data = await response.json();
    const jsonMatch = data.choices[0].message.content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('AI ì‘ë‹µì—ì„œ JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    
    let result: any;
    try {
      result = JSON.parse(jsonMatch[0]);
      console.log('íŒŒì‹±ëœ ê²°ê³¼:', result);
    } catch {
      throw new Error('AI ì‘ë‹µì˜ JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!result.missingSentence || !result.numberedPassage || typeof result.answerIndex !== 'number' || !result.translation) {
      throw new Error('AI ì‘ë‹µì— í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // answerIndex ë²”ìœ„ ê²€ì¦ (0~4)
    if (result.answerIndex < 0 || result.answerIndex > 4) {
      throw new Error('answerIndexëŠ” 0~4 ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    }

    // ì›ë¬¸ì ì¤‘ë³µ ì‚¬ìš© ê²€ì¦
    const numberedPassage = result.numberedPassage;
    const circles = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤'];
    for (const circle of circles) {
      const count = (numberedPassage.match(new RegExp(circle, 'g')) || []).length;
      if (count > 1) {
        throw new Error(`ì›ë¬¸ì ${circle}ê°€ ì¤‘ë³µ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }

    // â‘¥ ì´ìƒì˜ ì›ë¬¸ì ì‚¬ìš© ê¸ˆì§€ ê²€ì¦
    const invalidCircles = ['â‘¥', 'â‘¦', 'â‘§', 'â‘¨', 'â‘©'];
    for (const circle of invalidCircles) {
      if (numberedPassage.includes(circle)) {
        throw new Error(`ê¸ˆì§€ëœ ì›ë¬¸ì ${circle}ê°€ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }

    // ê¸ˆì§€ëœ í…ìŠ¤íŠ¸ ê²€ì¦
    const forbiddenTexts = ['ì •ë‹µìœ„ì¹˜', 'ì •ë‹µ', '(ì •ë‹µ:', '[ì •ë‹µ ìœ„ì¹˜:', '[ì •ë‹µ ìœ„ì¹˜]', 'ì •ë‹µ ìœ„ì¹˜', 'ìœ„ì¹˜', 'ì •ë‹µì€', 'ì •ë‹µì´', 'ì •ë‹µì„'];
    for (const text of forbiddenTexts) {
      if (numberedPassage.includes(text)) {
        throw new Error(`ê¸ˆì§€ëœ í…ìŠ¤íŠ¸ "${text}"ê°€ í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
    }

    console.log('âœ… Work_06 ë¬¸ì œ ìƒì„± ì™„ë£Œ:', result);
    return result;

  } catch (error) {
    console.error('âŒ Work_06 ë¬¸ì œ ìƒì„± ì‹¤íŒ¨:', error);
    throw error;
  }
}
