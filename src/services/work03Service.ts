/**
 * Work_03 (ë¹ˆì¹¸ ë‹¨ì–´ ë¬¸ì œ) ë¬¸ì œ ìƒì„± ë¡œì§
 * ì›ë³¸: src/components/work/Work_03_VocabularyWord/Work_03_VocabularyWord.tsx
 * 
 * ì´ íŒŒì¼ì€ ì›ë³¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¬¸ì œ ìƒì„± ë¡œì§ë§Œ ì¶”ì¶œí•œ ê²ƒì…ë‹ˆë‹¤.
 * ì›ë³¸ íŒŒì¼ì€ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ìœ¼ë©°, ë¡œì§ì„ ë³µì‚¬í•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */

import { callOpenAI, addVarietyToPrompt, getProblemGenerationTemperature } from './common';

/**
 * ë¹ˆì¹¸ ë¬¸ì œ íƒ€ì… ì •ì˜
 */
export interface BlankQuiz {
  blankedText: string;
  options: string[];
  answerIndex: number;
  translation?: string; // ë²ˆì—­ (ì„ íƒì )
}

/**
 * ìœ í˜•#03: ë¹ˆì¹¸(ë‹¨ì–´) ë¬¸ì œ ìƒì„±
 * @param passage - ì˜ì–´ ë³¸ë¬¸
 * @param previouslySelectedWords - ì´ì „ì— ì„ íƒëœ ë‹¨ì–´ ëª©ë¡ (ë™ì¼ ë³¸ë¬¸ìœ¼ë¡œ ì—¬ëŸ¬ ë²ˆ ìƒì„± ì‹œ ì‚¬ìš©)
 * @returns ë¹ˆì¹¸ ë¬¸ì œ ë°ì´í„°
 */
export async function generateWork03Quiz(
  passage: string, 
  previouslySelectedWords?: string[]
): Promise<BlankQuiz> {
  console.log('ğŸ” Work_03 ë¬¸ì œ ìƒì„± ì‹œì‘...');
  console.log('ğŸ“ ì…ë ¥ í…ìŠ¤íŠ¸ ê¸¸ì´:', passage.length);

  try {
    // passageì—ì„œ ì´ë¯¸ ()ë¡œ ë¬¶ì¸ ë‹¨ì–´ ì¶”ì¶œ (ì œì™¸ ëŒ€ìƒ)
    const excludedWords: string[] = [];
    const bracketRegex = /\(([^)]+)\)/g;
    let match;
    while ((match = bracketRegex.exec(passage)) !== null) {
      excludedWords.push(match[1].trim());
    }
    
    const prompt = `ì•„ë˜ ì˜ì–´ ë³¸ë¬¸ì„ ì½ê³ , **ëŒ€í•œë¯¼êµ­ ê³ ë“±í•™êµ êµìœ¡ê³¼ì • ìˆ˜í•™ëŠ¥ë ¥í‰ê°€(ìˆ˜ëŠ¥) ìˆ˜ì¤€**ì˜ ë¹ˆì¹¸ ì¶”ë¡  ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

**ğŸ¯ ìˆ˜ëŠ¥ ìˆ˜ì¤€ì˜ ì–´íœ˜ ì„ íƒ ê¸°ì¤€ (ì ˆëŒ€ í•„ìˆ˜):**

**ìˆ˜ëŠ¥ ì˜ì–´ ë¹ˆì¹¸ ì¶”ë¡  ë¬¸ì œì˜ íŠ¹ì§•:**
- ì‹¤ì œ ìˆ˜ëŠ¥ì—ì„œëŠ” ë³¸ë¬¸ ì „ì²´ì˜ ë§¥ë½ì„ ì´í•´í•˜ê³ , ì•ë’¤ ë¬¸ë§¥ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•´ì•¼ ë‹µì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ì–´íœ˜ë¥¼ ì¶œì œí•©ë‹ˆë‹¤.
- ë‹¨ìˆœíˆ ë‹¨ì–´ ìì²´ì˜ ì˜ë¯¸ë¥¼ ì•„ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë¬¸ë§¥ ì†ì—ì„œì˜ ì ì ˆí•œ ì˜ë¯¸ë¥¼ ì¶”ë¡ í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì„ í‰ê°€í•©ë‹ˆë‹¤.
- ì–´íœ˜ ë‚œì´ë„ëŠ” CEFR B2-C1 ìˆ˜ì¤€(ê³ ë“±í•™êµ 3-5ë“±ê¸‰ ì–´íœ˜)ì— í•´ë‹¹í•˜ë©°, í•™ìˆ ì  í…ìŠ¤íŠ¸ë‚˜ ë¬¸í•™ ì‘í’ˆì—ì„œ ìì£¼ ë“±ì¥í•˜ëŠ” ì–´íœ˜ì…ë‹ˆë‹¤.
- ì‹¤ì œ ìˆ˜ëŠ¥ ê¸°ì¶œ ë¬¸ì œë¥¼ ì°¸ê³ í•˜ì„¸ìš”: ë‹¨ì–´ ìì²´ê°€ ì–´ë µê¸°ë³´ë‹¤ëŠ” ë¬¸ë§¥ì—ì„œì˜ ì˜ë¯¸ ì¶”ë¡ ì´ ì¤‘ìš”í•œ ë‹¨ì–´ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.

1. **ë‹¨ì–´ ì„ ì • ê¸°ì¤€ (ë§¤ìš° ì¤‘ìš” - ë‹¤ì–‘ì„± í•„ìˆ˜):**
   - âŒ í”¼í•´ì•¼ í•  ë‹¨ì–´: ê³ ìœ ëª…ì‚¬, ê¸°ë³¸ ì–´íœ˜(a, an, the, is, are, was, were, go, come ë“±), ì¼ìƒ ëŒ€í™”ìš© ì–´íœ˜, ë„ˆë¬´ ì‰¬ìš´ ë‹¨ì–´
   - âœ… ì„ íƒí•´ì•¼ í•  ë‹¨ì–´: 
     * í•™ìˆ  ë…¼ë¬¸ì´ë‚˜ êµê³¼ì„œì—ì„œ ë“±ì¥í•˜ëŠ” ì–´íœ˜ (ì˜ˆ: analyze, demonstrate, significant, essential, phenomenon, perspective ë“±)
     * ë¬¸ë§¥ì— ë”°ë¼ ì˜ë¯¸ê°€ ë‹¬ë¼ì§€ëŠ” ë‹¤ì˜ì–´ (ì˜ˆ: address, concern, current, feature ë“±)
     * ì¶”ìƒì  ê°œë…ì„ í‘œí˜„í•˜ëŠ” ëª…ì‚¬/í˜•ìš©ì‚¬ (ì˜ˆ: profound, subtle, inherent, explicit, implicit ë“±)
     * ë³¸ë¬¸ì˜ ë…¼ë¦¬ì  íë¦„ì„ ì´í•´í•´ì•¼ ë‹µì„ ì°¾ì„ ìˆ˜ ìˆëŠ” ì–´íœ˜
   - **âš ï¸ ë‹¤ì–‘ì„± ìš”êµ¬ì‚¬í•­ (ì ˆëŒ€ í•„ìˆ˜):**
     * ë™ì¼í•œ ë³¸ë¬¸ìœ¼ë¡œ ì—¬ëŸ¬ ë²ˆ ë¬¸ì œë¥¼ ìƒì„±í•  ë•ŒëŠ” **ë°˜ë“œì‹œ ë³¸ë¬¸ì˜ ë‹¤ë¥¸ ìœ„ì¹˜ì—ì„œ ë‹¤ë¥¸ ë‹¨ì–´ë¥¼ ì„ íƒ**í•´ì•¼ í•©ë‹ˆë‹¤.
     * ì´ì „ì— ì„ íƒí•œ ë‹¨ì–´ì™€ëŠ” **ì™„ì „íˆ ë‹¤ë¥¸ ë‹¨ì–´**ë¥¼ ì„ íƒí•˜ì„¸ìš”.
     * ë³¸ë¬¸ì˜ ì²« ë¶€ë¶„, ì¤‘ê°„ ë¶€ë¶„, ë§ˆì§€ë§‰ ë¶€ë¶„ ë“± **ë‹¤ì–‘í•œ ìœ„ì¹˜**ì—ì„œ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.
     * ë³¸ë¬¸ì— ì—¬ëŸ¬ ê°œì˜ ì ì ˆí•œ ë‹¨ì–´ê°€ ìˆë‹¤ë©´, **ë§¤ë²ˆ ë‹¤ë¥¸ ë‹¨ì–´**ë¥¼ ì„ íƒí•˜ì„¸ìš”.
   - ë³¸ë¬¸ ì „ì²´ë¥¼ ì½ê³  ë§¥ë½ì„ ì´í•´í•œ í›„, ê·¸ ë§¥ë½ì—ì„œ ì ì ˆí•œ ì˜ë¯¸ë¥¼ ê°€ì§„ í•µì‹¬ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ë˜, **ì´ì „ì— ì„ íƒí•˜ì§€ ì•Šì€ ë‹¤ë¥¸ ë‹¨ì–´**ë¥¼ ì„ íƒí•˜ì„¸ìš”.
   - ë‹¨ì–´ë¥¼ ë‹¨ë…ìœ¼ë¡œ ë´¤ì„ ë•Œì˜ ì˜ë¯¸ë³´ë‹¤, **ë³¸ë¬¸ì—ì„œ ì‚¬ìš©ëœ ë§¥ë½ì—ì„œì˜ ì˜ë¯¸**ë¥¼ ì¶”ë¡ í•´ì•¼ í•˜ëŠ” ë‹¨ì–´ì—¬ì•¼ í•©ë‹ˆë‹¤.

2. **ì •ë‹µ ë‹¨ì–´ ìš”êµ¬ì‚¬í•­:**
   - ë°˜ë“œì‹œ ë³¸ë¬¸ì— ì‹¤ì œë¡œ ë“±ì¥í•œ ë‹¨ì–´(ì² ì, í˜•íƒœ, ëŒ€ì†Œë¬¸ìê¹Œì§€ ë™ì¼)ë¥¼ ì •ë‹µìœ¼ë¡œ ì„ ì •í•´ì•¼ í•´. ë³€í˜•, ëŒ€ì²´, ë™ì˜ì–´, ì–´í˜• ë³€í™” ì—†ì´ ë³¸ë¬¸ì— ìˆë˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì•¼ í•´.

3. **ë³¸ë¬¸ ì²˜ë¦¬ ê·œì¹™:**
   - ë¬¸ì œì˜ ë³¸ë¬¸(ë¹ˆì¹¸ í¬í•¨)ì€ ë°˜ë“œì‹œ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì „ì²´ ë³¸ë¬¸ê³¼ ì™„ì „íˆ ë™ì¼í•´ì•¼ í•˜ë©°, ì¼ë¶€ ë¬¸ì¥ë§Œ ì¶”ì¶œí•˜ê±°ë‚˜, ë¬¸ì¥ ìˆœì„œë¥¼ ë°”ê¾¸ê±°ë‚˜, ë³¸ë¬¸ì„ ìš”ì•½/ë³€í˜•í•´ì„œëŠ” ì•ˆ ë¼. ì˜¤ì§ ì •ë‹µ ë‹¨ì–´ë§Œ ()ë¡œ ì¹˜í™˜í•´.

4. **ì œì™¸ ëŒ€ìƒ:**
   - ì…ë ¥ëœ ë³¸ë¬¸ì— ì´ë¯¸ ()ë¡œ ë¬¶ì¸ ë‹¨ì–´ë‚˜ êµ¬ê°€ ìˆë‹¤ë©´, ê·¸ ë¶€ë¶„ì€ ì ˆëŒ€ ë¹ˆì¹¸ ì²˜ë¦¬ ëŒ€ìƒìœ¼ë¡œ ì‚¼ì§€ ë§ˆì„¸ìš”. ë°˜ë“œì‹œ ê´„í˜¸ ë°–ì— ìˆëŠ” ë‹¨ì–´ë§Œ ë¹ˆì¹¸ í›„ë³´ë¡œ ì„ ì •í•˜ì„¸ìš”.
   - ì•„ë˜ ë‹¨ì–´/êµ¬ëŠ” ì ˆëŒ€ ë¹ˆì¹¸ ì²˜ë¦¬í•˜ì§€ ë§ˆì„¸ìš”: ${excludedWords.length > 0 ? excludedWords.join(', ') : 'ì—†ìŒ'}
   ${previouslySelectedWords && previouslySelectedWords.length > 0 ? `
   - **âš ï¸ ë§¤ìš° ì¤‘ìš” - ì´ì „ ì„ íƒ ë‹¨ì–´ ì œì™¸:**
     * ì•„ë˜ ë‹¨ì–´ë“¤ì€ ì´ì „ì— ì´ë¯¸ ì„ íƒëœ ë‹¨ì–´ì…ë‹ˆë‹¤. ì´ ë‹¨ì–´ë“¤ì€ **ì ˆëŒ€ ì„ íƒí•˜ì§€ ë§ˆì„¸ìš”**:
     * ${previouslySelectedWords.map(word => `"${word}"`).join(', ')}
     * ìœ„ ë‹¨ì–´ë“¤ê³¼ëŠ” **ì™„ì „íˆ ë‹¤ë¥¸ ë‹¨ì–´**ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
     * ë³¸ë¬¸ì—ì„œ ìœ„ ë‹¨ì–´ë“¤ì„ ì œì™¸í•œ ë‹¤ë¥¸ ì ì ˆí•œ ë‹¨ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”.` : ''}

5. **5ì§€ì„ ë‹¤ ì„ íƒì§€ ìƒì„± (ìˆ˜ëŠ¥ ìŠ¤íƒ€ì¼):**
   - ì •ë‹µ(í•µì‹¬ë‹¨ì–´) + ì˜¤ë‹µ 4ê°œ = ì´ 5ê°œ ì„ íƒì§€
   - **ì˜¤ë‹µ ì„ ì • ê¸°ì¤€ (ì‹¤ì œ ìˆ˜ëŠ¥ ê¸°ì¶œ ìŠ¤íƒ€ì¼):**
     * ì •ë‹µê³¼ ê°™ì€ í’ˆì‚¬ì´ë©´ì„œ ì˜ë¯¸ê°€ ë¹„ìŠ·í•˜ì§€ë§Œ ë³¸ë¬¸ ë§¥ë½ì—ëŠ” ë§ì§€ ì•ŠëŠ” ë‹¨ì–´ (ì˜ˆ: answerê°€ ì •ë‹µì´ë©´, response, reply ë“±)
     * ì •ë‹µê³¼ ì² ìê°€ ë¹„ìŠ·í•˜ê±°ë‚˜ ë°œìŒì´ ë¹„ìŠ·í•œ ë‹¨ì–´ (í˜¼ë™ ìœ ë„ìš©)
     * ì •ë‹µê³¼ ë°˜ëŒ€ ì˜ë¯¸ë¥¼ ê°€ì§„ ë‹¨ì–´ (ë‹¨, ë³¸ë¬¸ ë§¥ë½ì—ì„œëŠ” ì ì ˆí•˜ì§€ ì•ŠìŒ)
     * ë³¸ë¬¸ ë§¥ë½ì—ì„œëŠ” ë…¼ë¦¬ì ìœ¼ë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ì—†ì§€ë§Œ, ë‹¤ë¥¸ ë§¥ë½ì—ì„œëŠ” ê°€ëŠ¥í•œ ì–´íœ˜
   - ìˆ˜ëŠ¥ì—ì„œëŠ” ë‹¨ìˆœíˆ "í‹€ë¦° ë‹¨ì–´"ê°€ ì•„ë‹ˆë¼, **ë³¸ë¬¸ ë§¥ë½ì„ ì •í™•íˆ ì´í•´í•˜ì§€ ëª»í•˜ë©´ ì„ íƒí•  ìˆ˜ ìˆëŠ” ì˜¤ë‹µ**ì„ ì¶œì œí•©ë‹ˆë‹¤.
   - ì˜ˆì‹œ: ë³¸ë¬¸ì´ "The study reveals that..."ì´ê³  ì •ë‹µì´ "reveals"ë¼ë©´, ì˜¤ë‹µìœ¼ë¡œ "shows", "indicates", "demonstrates" ë“±ì„ ì‚¬ìš© (ë§¥ë½ì´ ì •í™•í•˜ì§€ ì•Šìœ¼ë©´ í˜¼ë™ ê°€ëŠ¥)

6. **ì •ë‹µ ìœ„ì¹˜:**
   - ì •ë‹µì˜ ìœ„ì¹˜ëŠ” 1~5ë²ˆ ì¤‘ ëœë¤ìœ¼ë¡œ ë°°ì¹˜í•˜ì„¸ìš”.

7. **JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:**

{
  "options": ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3", "ì„ íƒì§€4", "ì„ íƒì§€5"],
  "answerIndex": 0
}

**âš ï¸ ìµœì¢… í™•ì¸ (ì‹¤ì œ ìˆ˜ëŠ¥ ê¸°ì¶œ ìŠ¤íƒ€ì¼ ê²€ì¦):**
- âœ… ë³¸ë¬¸ì„ ì½ì§€ ì•Šê³  ë‹¨ì–´ë§Œ ë´¤ì„ ë•ŒëŠ” ì •ë‹µì„ ì°¾ê¸° ì–´ë ¤ì›Œì•¼ í•©ë‹ˆë‹¤.
- âœ… ë³¸ë¬¸ ì „ì²´ì˜ ë…¼ë¦¬ì  íë¦„ê³¼ ë§¥ë½ì„ ì¢…í•©ì ìœ¼ë¡œ ì´í•´í•´ì•¼ ì •ë‹µì„ ì„ íƒí•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
- âœ… ë‹¨ìˆœíˆ ì‰¬ìš´ ë‹¨ì–´(a, the, is ë“±)ë‚˜ ê³ ìœ ëª…ì‚¬ëŠ” ì„ íƒí•˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
- âœ… CEFR B2-C1 ìˆ˜ì¤€(ê³ ë“±í•™êµ 3-5ë“±ê¸‰)ì˜ í•™ìˆ ì /ë¬¸í•™ì  ì–´íœ˜ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.
- âœ… ì˜¤ë‹µ ì„ íƒì§€ë“¤ì´ ë³¸ë¬¸ ë§¥ë½ì„ ì •í™•íˆ ì´í•´í•˜ì§€ ëª»í•˜ë©´ ì„ íƒí•  ìˆ˜ ìˆëŠ” ìœ ì‚¬í•œ ì–´íœ˜ë“¤ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.
- âœ… ì‹¤ì œ ìˆ˜ëŠ¥ ê¸°ì¶œ ë¬¸ì œì²˜ëŸ¼, ë¬¸ë§¥ ì¶”ë¡  ëŠ¥ë ¥ì„ í‰ê°€í•˜ëŠ” ë¬¸ì œì¸ì§€ ìµœì¢… ê²€ì¦í•˜ì„¸ìš”.

ì…ë ¥ëœ ì˜ì–´ ë³¸ë¬¸:
${passage}`;

    // ë‹¤ì–‘ì„± ì¶”ê°€
    const enhancedPrompt = addVarietyToPrompt(prompt);
    const temperature = getProblemGenerationTemperature(0.7);

    const response = await callOpenAI({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: enhancedPrompt }],
      max_tokens: 1200,
      temperature: temperature
    });

    if (!response.ok) {
      throw new Error(`OpenAI API ì˜¤ë¥˜: ${response.status}`);
    }

    const data = await response.json();
    console.log('AI ì‘ë‹µ ì „ì²´:', data);
    console.log('AI ì‘ë‹µ ë‚´ìš©:', data.choices[0].message.content);
    
    const jsonMatch = data.choices[0].message.content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('AI ì‘ë‹µì—ì„œ JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    
    console.log('ì¶”ì¶œëœ JSON:', jsonMatch[0]);
    
    let result: any;
    try {
      result = JSON.parse(jsonMatch[0]);
      console.log('íŒŒì‹±ëœ ê²°ê³¼:', result);
    } catch {
      throw new Error('AI ì‘ë‹µì˜ JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    // ì •ë‹µ ë‹¨ì–´ê°€ ë³¸ë¬¸ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ ê²€ì¦
    if (!passage.includes(result.options[result.answerIndex])) {
      throw new Error('ì •ë‹µ ë‹¨ì–´ê°€ ë³¸ë¬¸ì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. AI ì‘ë‹µ ì˜¤ë¥˜ì…ë‹ˆë‹¤.');
    }

    // blankedTextë¥¼ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ìƒì„± (ê´„í˜¸ split ë°©ì‹, ê´„í˜¸ ì•ˆ/ë°– ì™„ë²½ êµ¬ë¶„)
    const replaceFirstOutsideBrackets = (text: string, word: string): string => {
      let replaced = false;
      // ê´„í˜¸ë¡œ split (ê´„í˜¸ ì•ˆ/ë°– êµ¬ë¶„)
      const tokens = text.split(/([()])/);
      let inBracket = false;
      for (let i = 0; i < tokens.length; i++) {
        if (tokens[i] === '(') {
          inBracket = true;
          continue;
        }
        if (tokens[i] === ')') {
          inBracket = false;
          continue;
        }
        if (!inBracket && !replaced) {
          // ê´„í˜¸ ë°–ì—ì„œë§Œ ë‹¨ì–´ ì¹˜í™˜ (ë‹¨ì–´ ê²½ê³„ ì²´í¬)
          const regex = new RegExp(`\\b${word}\\b`);
          if (regex.test(tokens[i])) {
            tokens[i] = tokens[i].replace(regex, '(__________)');
            replaced = true;
          }
        }
      }
      // splitìœ¼ë¡œ ê´„í˜¸ê°€ ì‚¬ë¼ì§€ë¯€ë¡œ, ë‹¤ì‹œ ì¡°ë¦½
      let result = '';
      inBracket = false;
      for (let i = 0; i < tokens.length; i++) {
        if (tokens[i] === '(') {
          inBracket = true;
          result += '(';
          continue;
        }
        if (tokens[i] === ')') {
          inBracket = false;
          result += ')';
          continue;
        }
        result += tokens[i];
      }
      return result;
    };

    const answer = result.options[result.answerIndex];
    const blankedText = replaceFirstOutsideBrackets(passage, answer);
    result.blankedText = blankedText;
    
    // ë¹ˆì¹¸ ë³¸ë¬¸ì´ ì›ë³¸ ë³¸ë¬¸ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦
    const blankRestore = result.blankedText.replace(/\( *_{6,}\)/, answer);
    if (blankRestore.trim() !== passage.trim()) {
      throw new Error('ë¹ˆì¹¸ ë³¸ë¬¸ì´ ì›ë³¸ ë³¸ë¬¸ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. AI ì‘ë‹µ ì˜¤ë¥˜ì…ë‹ˆë‹¤.');
    }
    
    console.log('ìµœì¢… ê²€ì¦ ì „ ê²°ê³¼:', {
      blankedText: result.blankedText,
      options: result.options,
      answerIndex: result.answerIndex
    });
    
    if (!result.blankedText || !result.options || typeof result.answerIndex !== 'number') {
      throw new Error('AI ì‘ë‹µì— í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    
    console.log('âœ… Work_03 ë¬¸ì œ ìƒì„± ì™„ë£Œ:', result);
    return result;
    
  } catch (error) {
    console.error('âŒ Work_03 ë¬¸ì œ ìƒì„± ì‹¤íŒ¨:', error);
    throw error;
  }
}

