/**
 * Work_08 (ì œëª© ì¶”ë¡ ) ë¬¸ì œ ìƒì„± ë¡œì§
 * ì›ë³¸: src/components/work/Work_08_TitleInference/Work_08_TitleInference.tsx
 * 
 * ì´ íŒŒì¼ì€ ì›ë³¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¬¸ì œ ìƒì„± ë¡œì§ë§Œ ì¶”ì¶œí•œ ê²ƒì…ë‹ˆë‹¤.
 * ì›ë³¸ íŒŒì¼ì€ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ìœ¼ë©°, ë¡œì§ì„ ë³µì‚¬í•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
 */

import { callOpenAI, translateToKorean } from './common';

/**
 * ì œëª© ì¶”ë¡  ë¬¸ì œ íƒ€ì… ì •ì˜
 */
export interface TitleQuiz {
  passage: string;
  options: string[];
  answerIndex: number;
  translation: string;
  answerTranslation: string;
  optionTranslations: string[];
}

/**
 * ìœ í˜•#08: ì œëª© ì¶”ë¡  ë¬¸ì œ ìƒì„±
 * @param passage - ì˜ì–´ ë³¸ë¬¸
 * @returns ì œëª© ì¶”ë¡  ë¬¸ì œ ë°ì´í„°
 */
export async function generateWork08Quiz(passage: string): Promise<TitleQuiz> {
  console.log('ğŸ” Work_08 ë¬¸ì œ ìƒì„± ì‹œì‘...');
  console.log('ğŸ“ ì…ë ¥ í…ìŠ¤íŠ¸ ê¸¸ì´:', passage.length);

  try {
    const prompt = `ì•„ë˜ ì˜ì–´ ë³¸ë¬¸ì„ ì½ê³ , **ëŒ€í•œë¯¼êµ­ ê³ ë“±í•™êµ êµìœ¡ê³¼ì • ìˆ˜í•™ëŠ¥ë ¥í‰ê°€(ìˆ˜ëŠ¥) ìˆ˜ì¤€**ì˜ ì œëª© ì¶”ë¡  ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

**ğŸ¯ ìˆ˜ëŠ¥ ì œëª© ì¶”ë¡  ë¬¸ì œì˜ íŠ¹ì§•:**
- ì‹¤ì œ ìˆ˜ëŠ¥ì—ì„œëŠ” ë³¸ë¬¸ ì „ì²´ì˜ í•µì‹¬ ë‚´ìš©, ì €ìì˜ ì˜ë„, ê¸€ì˜ ëª©ì ì„ ì¢…í•©ì ìœ¼ë¡œ ì´í•´í•´ì•¼ ì ì ˆí•œ ì œëª©ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë‹¨ìˆœíˆ ë³¸ë¬¸ì˜ í‚¤ì›Œë“œë¥¼ ë‚˜ì—´í•œ ì œëª©ì´ ì•„ë‹ˆë¼, **ë³¸ë¬¸ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ í•¨ì¶•ì ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ì œëª©**ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
- ìˆ˜ëŠ¥ ìˆ˜ì¤€ì˜ ì œëª©ì€ ë³¸ë¬¸ì˜ í‘œë©´ì  ë‚´ìš©ì´ ì•„ë‹Œ, **ì €ìì˜ ê´€ì , ê¸€ì˜ ëª©ì , ë…¼ë¦¬ì  ê²°ë¡ **ì„ ë°˜ì˜í•©ë‹ˆë‹¤.
- ì¤‘í•™êµ ìˆ˜ì¤€ì˜ ë‹¨ìˆœí•œ ì œëª©ì´ ì•„ë‹Œ, ê³ ë“±í•™êµ ìˆ˜ì¤€ì˜ ì¶”ìƒì ì´ê³  í•¨ì¶•ì ì¸ ì œëª©ì„ ë‹¤ë£¹ë‹ˆë‹¤.

**âš ï¸ ì ˆëŒ€ í”¼í•´ì•¼ í•  ì œëª©:**
- âŒ ë³¸ë¬¸ì˜ ì²« ë¬¸ì¥ì´ë‚˜ ë§ˆì§€ë§‰ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œ ì œëª©
- âŒ ë³¸ë¬¸ì˜ í‚¤ì›Œë“œë§Œ ë‚˜ì—´í•œ ì œëª© (ì˜ˆ: "Technology, Education, Future")
- âŒ ë„ˆë¬´ êµ¬ì²´ì ì´ê³  ë‹¨ìˆœí•œ ì œëª© (ì˜ˆ: "How to Make Coffee")
- âŒ ë³¸ë¬¸ ë‚´ìš©ê³¼ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ ì—†ëŠ” ì¼ë°˜ì ì¸ ì œëª©
- âŒ ë³¸ë¬¸ì˜ ë¶€ì°¨ì  ë‚´ìš©ë§Œ ë‹¤ë£¬ ì œëª©

**âœ… ìˆ˜ëŠ¥ ìˆ˜ì¤€ì˜ ì œëª© ì„ ì • ê¸°ì¤€:**
1. **ë³¸ë¬¸ ì „ì²´ë¥¼ ì •í™•íˆ ë¶„ì„:**
   - ë³¸ë¬¸ì˜ ëª¨ë“  ë¬¸ë‹¨ì„ ì½ê³  ê° ë¬¸ë‹¨ì˜ ì—­í• ì„ íŒŒì•…í•˜ì„¸ìš”
   - ì €ìì˜ ì£¼ì¥, ê·¼ê±°, ê²°ë¡ ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì„¸ìš”
   - ê¸€ì˜ ë…¼ë¦¬ì  êµ¬ì¡°ì™€ í•µì‹¬ ë©”ì‹œì§€ë¥¼ íŒŒì•…í•˜ì„¸ìš”

2. **í•¨ì¶•ì ì´ê³  í¬ê´„ì ì¸ ì œëª© ì„ íƒ:**
   - ë³¸ë¬¸ì˜ êµ¬ì²´ì  ë‚´ìš©ì„ ë„˜ì–´ì„œëŠ” **ì¶”ìƒì  ê°œë…**ì„ ë‹¤ë£¨ëŠ” ì œëª©
   - ì˜ˆ: "The Paradox of Modern Technology" (í˜„ëŒ€ ê¸°ìˆ ì˜ ì—­ì„¤)
   - ì˜ˆ: "Rethinking Education in the Digital Age" (ë””ì§€í„¸ ì‹œëŒ€ì˜ êµìœ¡ ì¬ê³ )
   - ì˜ˆ: "Sustainable Development: Challenges and Solutions" (ì§€ì†ê°€ëŠ¥í•œ ë°œì „: ë„ì „ê³¼ í•´ê²°ì±…)
   - ìˆ˜ëŠ¥ ê¸°ì¶œ ìŠ¤íƒ€ì¼: ëª…í™•í•˜ê³  ê°„ê²°í•˜ë©°, ë³¸ë¬¸ì˜ í•µì‹¬ì„ í•¨ì¶•ì ìœ¼ë¡œ í‘œí˜„

3. **ì €ìì˜ ì˜ë„ì™€ ëª©ì ì„ ë°˜ì˜:**
   - ë‹¨ìˆœ ì •ë³´ ì „ë‹¬ì´ ì•„ë‹Œ, ì €ìê°€ ë…ìì—ê²Œ ì „ë‹¬í•˜ë ¤ëŠ” **í•µì‹¬ ë©”ì‹œì§€**ë¥¼ ë‹´ì€ ì œëª©
   - ì €ìì˜ ê´€ì , íƒœë„, ì œì•ˆì„ í¬í•¨í•˜ëŠ” ì œëª©

4. **ì •ë‹µ ì œëª© ìƒì„±:**
   - ë³¸ë¬¸ ì „ì²´ë¥¼ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•œ í›„, ê°€ì¥ ì ì ˆí•œ ì œëª©ì„ ìƒì„±
   - ì œëª©ì€ ë³´í†µ ëª…ì‚¬êµ¬, ë™ëª…ì‚¬êµ¬, ë˜ëŠ” ì§§ì€ ë¬¸ì¥ í˜•íƒœ
   - ìˆ˜ëŠ¥ ê¸°ì¶œ ë¬¸ì œ ìŠ¤íƒ€ì¼: ê°„ê²°í•˜ê³  í•¨ì¶•ì ì´ë©°, ë³¸ë¬¸ì˜ í•µì‹¬ì„ ì •í™•íˆ ë‹´ê³  ìˆì–´ì•¼ í•¨

5. **ì˜¤ë‹µ ì œëª© ìƒì„± (ìˆ˜ëŠ¥ ìŠ¤íƒ€ì¼):**
   - ë³¸ë¬¸ì˜ ì¼ë¶€ ë‚´ìš©ë§Œ ë°˜ì˜í•œ ì œëª© (ë¶€ë¶„ì  ì´í•´)
   - ë³¸ë¬¸ê³¼ ê´€ë ¨ì€ ìˆì§€ë§Œ ë„ˆë¬´ êµ¬ì²´ì ì´ê±°ë‚˜ ì¢ì€ ì œëª©
   - ë³¸ë¬¸ê³¼ ê´€ë ¨ì€ ìˆì§€ë§Œ ì €ìì˜ ì˜ë„ì™€ ë‹¤ë¥¸ ì œëª©
   - ë³¸ë¬¸ì˜ ë¶€ì°¨ì  ë‚´ìš©ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ì œëª©
   - ë³¸ë¬¸ì˜ í‘œë©´ì  ë‚´ìš©ë§Œ ë‹¤ë£¬ ì œëª©
   - ë³¸ë¬¸ì˜ í‚¤ì›Œë“œë§Œ ë‚˜ì—´í•œ ì œëª©

ìš”êµ¬ì‚¬í•­:
1. ì •ë‹µ ì œëª©(ë¬¸ì¥/êµ¬) + ì˜¤ë‹µ(ë¹„ìŠ·í•œ ê¸¸ì´ì˜ ì œëª© 4ê°œ, ì˜ë¯¸ëŠ” ë‹¤ë¦„) ì´ 5ê°œë¥¼ ìƒì„±
2. ì •ë‹µì˜ ìœ„ì¹˜ëŠ” 1~5ë²ˆ ì¤‘ ëœë¤
3. ë³¸ë¬¸ í•´ì„ë„ í•¨ê»˜ ì œê³µ
4. ê° ì˜µì…˜(1ë²ˆ~5ë²ˆ)ì— ëŒ€í•œ í•œê¸€ í•´ì„ì„ ë°˜ë“œì‹œ ì œê³µ

ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œ ì •í™•íˆ ì‘ë‹µí•´ì¤˜:

{
  "passage": "ì˜ì–´ ë³¸ë¬¸ ë‚´ìš©",
  "options": ["ì²«ë²ˆì§¸ ì˜µì…˜ ì œëª©", "ë‘ë²ˆì§¸ ì˜µì…˜ ì œëª©", "ì„¸ë²ˆì§¸ ì˜µì…˜ ì œëª©", "ë„¤ë²ˆì§¸ ì˜µì…˜ ì œëª©", "ë‹¤ì„¯ë²ˆì§¸ ì˜µì…˜ ì œëª©"],
  "answerIndex": 2,
  "translation": "ë³¸ë¬¸ì˜ í•œê¸€ í•´ì„",
  "answerTranslation": "ì •ë‹µ ì œëª©ì˜ í•œê¸€ í•´ì„",
  "optionTranslations": ["ì²«ë²ˆì§¸ ì˜µì…˜ì˜ í•œê¸€ í•´ì„", "ë‘ë²ˆì§¸ ì˜µì…˜ì˜ í•œê¸€ í•´ì„", "ì„¸ë²ˆì§¸ ì˜µì…˜ì˜ í•œê¸€ í•´ì„", "ë„¤ë²ˆì§¸ ì˜µì…˜ì˜ í•œê¸€ í•´ì„", "ë‹¤ì„¯ë²ˆì§¸ ì˜µì…˜ì˜ í•œê¸€ í•´ì„"]
}

ë³¸ë¬¸:
${passage}

ì¤‘ìš”: optionTranslations ë°°ì—´ì—ëŠ” ë°˜ë“œì‹œ 5ê°œì˜ í•œê¸€ í•´ì„ì´ ìˆœì„œëŒ€ë¡œ ë“¤ì–´ê°€ì•¼ í•©ë‹ˆë‹¤. ê° ì˜µì…˜ì˜ ì œëª©ì„ í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë²ˆì—­í•´ì£¼ì„¸ìš”.`;

    const response = await callOpenAI({
      model: 'gpt-4o',
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 2000,
      temperature: 0.7
    });

    if (!response.ok) {
      throw new Error(`OpenAI API ì˜¤ë¥˜: ${response.status}`);
    }

    const data = await response.json();
    const jsonMatch = data.choices[0].message.content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('AI ì‘ë‹µì—ì„œ JSON í˜•ì‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    
    let result: any;
    try {
      result = JSON.parse(jsonMatch[0]);
    } catch {
      throw new Error('AI ì‘ë‹µì˜ JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!result.passage || !result.options || typeof result.answerIndex !== 'number' || !result.translation) {
      throw new Error('AI ì‘ë‹µì— í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // answerTranslationì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ë³´ì™„
    if (!result.answerTranslation) {
      result.answerTranslation = '';
    }

    // optionTranslationsê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ë³´ì™„
    if (!result.optionTranslations || !Array.isArray(result.optionTranslations)) {
      result.optionTranslations = result.options.map(() => '');
    }

    // answerIndex ë²”ìœ„ ê²€ì¦
    if (result.answerIndex < 0 || result.answerIndex > 4) {
      throw new Error('answerIndexëŠ” 0~4 ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    }

    // options ë°°ì—´ ê¸¸ì´ ê²€ì¦
    if (result.options.length !== 5) {
      throw new Error('optionsëŠ” ì •í™•íˆ 5ê°œì˜ ì„ íƒì§€ì—¬ì•¼ í•©ë‹ˆë‹¤.');
    }

    // optionTranslations ë°°ì—´ ê¸¸ì´ ê²€ì¦ ë° ë³´ì™„
    if (result.optionTranslations.length !== 5) {
      // ë¶€ì¡±í•œ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ ì±„ì›€
      while (result.optionTranslations.length < 5) {
        result.optionTranslations.push('');
      }
      // ì´ˆê³¼í•˜ëŠ” ê²½ìš° ìë¦„
      if (result.optionTranslations.length > 5) {
        result.optionTranslations = result.optionTranslations.slice(0, 5);
      }
    }

    console.log('âœ… Work_08 ë¬¸ì œ ìƒì„± ì™„ë£Œ:', result);
    return result;

  } catch (error) {
    console.error('âŒ Work_08 ë¬¸ì œ ìƒì„± ì‹¤íŒ¨:', error);
    throw error;
  }
}
