# 작업내역 - 2025년 1월 10일

## 개요
Type #09 문법 오류 문제 생성 시스템의 근본적인 문제를 해결하기 위해 MCP(Model Context Protocol) 방식으로 전면 개선 작업을 진행했습니다.

## 발견된 주요 문제점

### 1. 단어 변형 미적용 문제
- **문제**: AI가 단어를 변형했다고 하지만 실제 본문에는 원본 단어가 그대로 유지됨
- **예시**: 원문 "violent"가 그대로 있는데 정답이라고 지목하는 오류
- **원인**: MCP 단계 순서 문제 및 본문 적용 로직 오류

### 2. 번호 순서 문제  
- **문제**: 본문 등장 순서가 아닌 선정된 단어 순서대로 번호가 매겨짐
- **예시**: 1,2,5,3,4 순서로 번호가 잘못 배치됨
- **원인**: `applyNumberAndUnderline` 함수의 로직 오류

### 3. 해설 품질 문제
- **문제**: 틀린 해설이나 의미 없는 해설 생성
- **예시**: "equivalently는 individual과 다른 형용사..." 같은 잘못된 설명
- **원인**: MCP 4 프롬프트의 모호함

## 해결 방안

### 1. MCP 순서 재정렬
**기존 순서:**
1. 단어 선정 → 2. 번호/밑줄 적용 → 3. 어법 변형 → 4. 해설 → 5. 번역

**수정된 순서:**
1. 단어 선정 → 3. 어법 변형 → 2. 본문 적용 → 4. 해설 → 5. 번역

**핵심**: 어법 변형을 먼저 하고 변형된 단어들을 본문에 적용

### 2. MCP 3 (어법 변형 서비스) 강화

#### 프롬프트 개선
```markdown
기존: 한국어로 된 애매한 설명
수정: 구체적인 영어 예시와 명확한 요구사항

- "individual" → "individuals" (wrong number)
- "violent" → "violently" (wrong part of speech)
- "depends" → "depend" (wrong subject-verb agreement)
```

#### 유효성 검증 강화
```typescript
// 실제 단어 변형 검증
if (originalWord === transformedWord) {
  throw new Error(`단어가 실제로 변형되지 않았습니다`);
}

// 원본 단어 일치 검증
if (result.original !== originalWord) {
  throw new Error(`원본 단어가 일치하지 않습니다`);
}
```

#### 재시도 로직 추가
- 최대 3번까지 재시도
- 각 시도마다 temperature 조정 (0.7)
- 실패 원인별 상세 로깅

### 3. MCP 2 (번호/밑줄 적용) 완전 재작성

#### 기존 문제
```typescript
// 변형된 단어 배열만 받아서 본문에서 찾으려 함
function applyNumberAndUnderline(passage: string, words: string[])
```

#### 해결 방법
```typescript
// 원본과 변형된 단어 모두 받아서 매핑 처리
function applyNumberAndUnderline(
  passage: string, 
  originalWords: string[], 
  transformedWords: string[]
)
```

#### 등장 순서대로 번호 매기기
1. **위치 찾기**: 본문에서 각 단어의 등장 위치 파악
2. **순서 정렬**: 등장 위치 순서대로 정렬
3. **번호 적용**: 순서대로 ①②③④⑤ 번호 매기기
4. **매핑 저장**: 정답 위치 재계산을 위한 매핑 정보 저장

### 4. MCP 4 (해설 생성) 개선

#### 프롬프트 구체화
```markdown
기존: "왜 틀렸는지 간단명료하게 설명"
수정: 구체적인 형식과 예시 제공

예시 형식:
"'equivalently'는 부사형으로 여기서는 형용사 'equivalent'가 적절합니다."
```

#### 해설 작성 규칙 명시화
1. 틀린 단어가 잘못된 이유 명시
2. 구체적인 어법 규칙 설명  
3. 정답이 맞는 이유 설명
4. 60자 이내 간결한 설명

### 5. 정답 위치 재계산 로직

#### 문제 상황
- 선정 순서: [distribute, individual, violent, unpredictable, dependable]
- 등장 순서: [distribute, equivalent, violent, unpredictable, dependable] 
- individual이 2번이었지만 본문에서는 2번째로 등장

#### 해결책
```typescript
// 번호 순서에 따른 정답 위치 재계산
const wordOrderMapping = (window as any).wordOrderMapping as number[];
const newAnswerIndex = wordOrderMapping.findIndex(originalIndex => originalIndex === transformation.answerIndex);

// 본문 등장 순서대로 정렬된 단어 배열
const orderedTransformedWords = wordOrderMapping.map(originalIndex => transformation.transformedWords[originalIndex]);
```

## 구현된 코드 변경사항

### 1. src/components/Work_09_GrammarError.tsx

#### MCP 3: 어법 변형 서비스
- 영어 프롬프트로 변경
- 구체적인 변형 예시 추가
- 재시도 로직 구현 (최대 3회)
- 강화된 유효성 검증

#### MCP 2: 번호/밑줄 적용 서비스  
- 원본↔변형 단어 매핑 기능
- 본문 등장 순서대로 번호 매기기
- 위치 변화 방지를 위한 역순 처리
- 매핑 정보 저장

#### MCP 4: 해설 생성 서비스
- 구체적인 형식 지정
- 상황 설명 추가  
- 예시 형식 제공

#### MCP 6: 통합 서비스
- 실행 순서 변경 (3→2 순서)
- 정답 위치 재계산 로직
- 상세한 진행 상황 로깅

## 예상 결과

### 올바른 동작 흐름
1. **Step 1**: 5개 단어 선정 
   ```
   ["distribute", "individual", "violent", "unpredictable", "dependable"]
   ```

2. **Step 3**: 어법 변형 (individual → individuals)
   ```
   변형: ["distribute", "individuals", "violent", "unpredictable", "dependable"]
   정답위치: 1 (individual)
   ```

3. **Step 2**: 본문 적용 + 등장순 번호
   ```
   본문: "...each ②<u>individuals</u> to a group..."
   등장순: [distribute(1), individuals(2), violent(3), unpredictable(4), dependable(5)]
   ```

4. **Step 4**: 정확한 해설
   ```
   "'individuals'는 복수형으로 여기서는 단수형 'individual'이 적절합니다."
   ```

### 최종 문제 형태
- **문제**: 틀린 형태(individuals)가 본문에 출제됨
- **정답**: ② individual (올바른 형태)
- **해설**: 문법적 근거가 명확한 설명
- **번호**: 본문 등장 순서대로 ①②③④⑤

## 기술적 개선사항

### 1. 에러 처리 강화
- 각 MCP 단계별 상세한 검증
- 재시도 메커니즘 구현
- 실패 원인별 구체적 에러 메시지

### 2. 로깅 시스템 개선
- 각 단계별 진행 상황 출력
- 단어 변형 과정 추적
- 번호 매핑 정보 표시

### 3. 유지보수성 향상
- 각 MCP의 단일 책임 명확화
- 재사용 가능한 모듈화
- 타입 안정성 확보

## 향후 개선 방향

### 1. 단기 개선사항
- 더 다양한 어법 유형 대응
- 해설 품질 추가 개선
- 성능 최적화

### 2. 장기 개선사항  
- 다른 문제 유형에 MCP 방식 적용
- 통합 문제 생성 시스템 구축
- AI 모델 업그레이드 대응

## 결론

기존의 단일 AI 호출 방식에서 MCP(Model Context Protocol) 방식으로 전환함으로써:

1. **안정성 향상**: 각 단계별 검증과 재시도로 실패율 감소
2. **품질 개선**: 전문화된 각 MCP로 결과물 품질 향상  
3. **유지보수성**: 모듈화된 구조로 개별 수정 가능
4. **확장성**: 다른 문제 유형에도 적용 가능한 구조

이번 개선으로 Type #09 문법 오류 문제 생성 시스템이 실용적인 수준으로 발전했습니다. 