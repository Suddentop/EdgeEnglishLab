# 🚨 긴급 서버 배포 가이드

## 현재 상황
- **프록시 서버 접속**: "Method Not Allowed" → **정상** (GET 요청 차단)
- **실제 문제**: 서버의 `.env` 파일이 없거나 권한 문제로 API 키를 로드하지 못함

---

## 📁 서버에 업로드해야 할 파일

### 1단계: PHP 프록시 파일 업로드

#### 업로드할 파일 목록
```
D:\Dev\engquiz\php_api_proxy\
├── api-proxy.php          → /public_html/php_api_proxy/api-proxy.php
├── load-env.php           → /public_html/php_api_proxy/load-env.php
├── test-env.php           → /public_html/php_api_proxy/test-env.php (테스트용)
└── .env                   → /public_html/php_api_proxy/.env
```

#### `.env` 파일 내용 (서버에 생성)
```env
# dothome.co.kr 서버 환경 변수 설정
# 실제 서버에서 이 파일을 .env로 복사하여 사용

# OpenAI API Key (서버에서만 사용)
OPENAI_API_KEY=<YOUR_OPENAI_API_KEY>

# API 설정
API_RATE_LIMIT=300
API_TIMEOUT=60

# 허용된 도메인
ALLOWED_ORIGIN_1=https://edgeenglish.net
ALLOWED_ORIGIN_2=https://www.edgeenglish.net

# 로그 설정
LOG_LEVEL=INFO
LOG_FILE=api_logs.txt
```

---

## 🔧 FTP 업로드 방법

### 1. FTP 클라이언트로 접속
- **호스트**: ftp.dothome.co.kr (또는 서버 주소)
- **사용자명**: (사용자 계정)
- **비밀번호**: (사용자 비밀번호)

### 2. 디렉토리 구조 확인
```
/public_html/
├── index.html
├── static/
│   ├── css/
│   └── js/
└── php_api_proxy/          ← 이 폴더에 업로드
    ├── api-proxy.php
    ├── load-env.php
    ├── test-env.php
    └── .env               ← 중요!
```

### 3. 파일 업로드
1. `php_api_proxy/` 폴더가 없으면 생성
2. 위 4개 파일을 모두 업로드
3. **`.env` 파일은 반드시 `.env`로 이름 확인**

### 4. 파일 권한 설정 (중요!)
```bash
# SSH 접속 또는 FTP 클라이언트에서 설정
chmod 644 /public_html/php_api_proxy/api-proxy.php
chmod 644 /public_html/php_api_proxy/load-env.php
chmod 644 /public_html/php_api_proxy/test-env.php
chmod 600 /public_html/php_api_proxy/.env  # 보안상 중요!
```

**FTP 클라이언트 (FileZilla 등)에서**:
1. `.env` 파일 우클릭
2. "파일 권한" 또는 "File Permissions" 선택
3. 숫자 값: `600` 입력
4. 또는 체크박스:
   - Owner: Read ✓, Write ✓
   - Group: (모두 비활성화)
   - Public: (모두 비활성화)

---

## 🧪 테스트 방법

### 1단계: 환경변수 로드 테스트
```
https://edgeenglish.net/php_api_proxy/test-env.php
```

**예상 결과**:
```json
{
  "status": "OK",
  "env_file_exists": true,
  "env_file_readable": true,
  "api_key_loaded": true,
  "api_key_first_10_chars": "sk-proj-oZ",
  "allowed_origin_1": "https://edgeenglish.net",
  "allowed_origin_2": "https://www.edgeenglish.net",
  "rate_limit": "300",
  "current_directory": "/home/계정명/public_html/php_api_proxy",
  "php_version": "7.4.x"
}
```

**문제가 있을 경우**:
```json
{
  "status": "OK",
  "env_file_exists": false,        ← .env 파일이 없음!
  "env_file_readable": false,      ← 권한 문제!
  "api_key_loaded": false,         ← API 키 로드 실패!
  ...
}
```

### 2단계: 프록시 서버 테스트
```
https://edgeenglish.net/php_api_proxy/api-proxy.php
```

**예상 결과** (GET 요청):
```json
{"error":"Method not allowed"}
```
→ **이것은 정상입니다!** GET 요청을 차단한 것입니다.

### 3단계: 실제 사이트에서 테스트
```
https://edgeenglish.net
```

1. 아무 유형 선택 (예: Work #01)
2. 이미지 붙여넣기 또는 파일 첨부
3. "문제생성" 클릭
4. 개발자 도구 콘솔 확인:

**성공 시**:
```
🔍 환경 변수 확인:
  proxyUrl: 설정됨
  directApiKey: 없음

🤖 OpenAI 프록시 서버 호출 중...
✅ 200 OK
```

**실패 시**:
```
❌ API 오류: 500 - API Key not configured
또는
❌ CORS policy: No 'Access-Control-Allow-Origin' header
```

---

## 🚨 문제 해결

### 문제 1: `env_file_exists: false`
**원인**: `.env` 파일이 서버에 없음

**해결**:
1. FTP로 `.env` 파일 확인
2. 파일 이름이 `.env`인지 확인 (`.env.txt` 아님!)
3. 파일 위치: `/public_html/php_api_proxy/.env`

### 문제 2: `env_file_readable: false`
**원인**: 파일 권한 문제

**해결**:
```bash
chmod 600 /public_html/php_api_proxy/.env
```

### 문제 3: `api_key_loaded: false`
**원인**: `.env` 파일에 API 키가 없거나 형식 오류

**해결**:
1. `.env` 파일 내용 확인
2. `OPENAI_API_KEY=sk-proj-...` 형식 확인
3. 줄바꿈 문자 확인 (Unix 형식: LF)

### 문제 4: CORS 에러
**원인**: CORS 헤더 설정 문제

**해결**:
`api-proxy.php` 파일에서 CORS 헤더 확인:
```php
$allowedOrigins = [
    'https://edgeenglish.net',
    'https://www.edgeenglish.net',
    'http://localhost:3000',
    'http://localhost:3001'
];
```

---

## 📋 체크리스트

### 서버 파일 업로드
- [ ] `api-proxy.php` 업로드
- [ ] `load-env.php` 업로드
- [ ] `test-env.php` 업로드 (테스트용)
- [ ] `.env` 파일 업로드
- [ ] `.env` 파일 권한 600 설정

### 테스트
- [ ] `test-env.php` 접속하여 환경변수 로드 확인
- [ ] `api-proxy.php` 접속하여 "Method not allowed" 확인
- [ ] 실제 사이트에서 이미지 처리 테스트

### 개발 환경
- [ ] 개발 서버 재시작 (`npm start`)
- [ ] `.env.local` 파일 존재 확인
- [ ] 개발 환경에서 이미지 처리 테스트

---

## 🔄 개발 서버 재시작 방법

### Windows PowerShell
```powershell
# 기존 프로세스 종료
Get-Process -Name node | Stop-Process -Force

# 개발 서버 시작
cd D:\Dev\engquiz
npm start
```

### 확인 사항
1. 브라우저 자동 실행: `http://localhost:3000`
2. 콘솔 메시지:
   ```
   Compiled successfully!
   You can now view engquiz in the browser.
   ```

---

## 📞 추가 지원

### 문제 지속 시
1. `test-env.php` 결과를 JSON으로 복사
2. 브라우저 개발자 도구 콘솔 스크린샷
3. Network 탭에서 `api-proxy.php` 요청 상세 정보

---

**🎯 핵심**: 서버의 `.env` 파일이 제대로 업로드되고 권한이 600으로 설정되어야 합니다!




