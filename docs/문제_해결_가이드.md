# 🛠️ dothome.co.kr 백엔드 서버 문제 해결 가이드

## 📋 개요

dothome.co.kr PHP 백엔드 서버 운영 중 발생할 수 있는 문제들과 해결 방법을 상세히 설명합니다.

## 🚨 긴급 문제 해결

### 1. API 서버 완전 다운
**증상**: 모든 API 요청이 실패
**긴급 조치**:
1. dothome.co.kr 서버 상태 확인
2. PHP 서비스 재시작
3. 파일 권한 확인
4. 로그 파일 확인

```bash
# 긴급 복구 명령어
chmod 644 *.php
chmod 644 .htaccess
rm rate_limit.json  # 요청 제한 리셋
```

### 2. API Key 노출 위험
**증상**: API Key가 클라이언트에서 노출됨
**긴급 조치**:
1. 즉시 새로운 API Key 발급
2. 기존 API Key 비활성화
3. config.php 파일 업데이트
4. 모든 클라이언트 재배포

## 🔍 일반적인 문제들

### A. API 연결 문제

#### A1. API Key 오류
```
Error: API Key not configured
```

**원인 분석**:
- config.php 파일의 API Key 설정 문제
- 환경 변수 로드 실패
- 파일 업로드 불완전

**해결 방법**:
1. **config.php 파일 확인**
```php
<?php
// config.php 내용 확인
$apiKey = getenv('OPENAI_API_KEY');
if (!$apiKey) {
    error_log('CRITICAL: OPENAI_API_KEY environment variable not set');
    die('Server configuration error: API key not configured');
}
define('OPENAI_API_KEY', $apiKey);
// ... 기타 설정
?>
```

2. **파일 권한 확인**
```bash
chmod 644 config.php
```

3. **직접 테스트**
```php
// test-config.php 파일 생성하여 테스트
<?php
require_once 'config.php';
echo "API Key: " . substr($config['OPENAI_API_KEY'], 0, 20) . "...";
?>
```

#### A2. OpenAI API 서버 오류
```
OpenAI API Error: HTTP 500 - Internal Server Error
```

**원인 분석**:
- OpenAI 서버 일시적 장애
- API Key 권한 문제
- 요청 형식 오류

**해결 방법**:
1. **OpenAI 상태 페이지 확인**
   - https://status.openai.com/ 접속
   - 서비스 상태 확인

2. **API Key 유효성 확인**
```php
// API Key 테스트 스크립트
<?php
$apiKey = 'your_api_key_here';
$response = file_get_contents('https://api.openai.com/v1/models', false, stream_context_create([
    'http' => [
        'header' => "Authorization: Bearer $apiKey\r\n",
    ],
]));
echo $response;
?>
```

3. **요청 재시도 로직 구현**
```php
function callOpenAIWithRetry($data, $maxRetries = 3) {
    for ($i = 0; $i < $maxRetries; $i++) {
        $response = callOpenAI($data);
        if ($response['success']) {
            return $response;
        }
        sleep(pow(2, $i)); // 지수 백오프
    }
    return ['success' => false, 'error' => 'Max retries exceeded'];
}
```

### B. CORS 문제

#### B1. CORS 정책 위반
```
Access to fetch at 'https://edgeenglish.net/secure-api-proxy.php' 
from origin 'https://edgeenglish.net' has been blocked by CORS policy
```

**원인 분석**:
- .htaccess 파일의 CORS 설정 문제
- 도메인 설정 불일치
- 브라우저 캐시 문제

**해결 방법**:
1. **.htaccess 파일 확인**
```apache
<IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin "https://edgeenglish.net"
    Header always set Access-Control-Allow-Methods "POST, GET, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
</IfModule>
```

2. **도메인 정확성 확인**
   - www 포함 여부 확인
   - HTTP vs HTTPS 확인
   - 서브도메인 설정 확인

3. **브라우저 캐시 클리어**
```javascript
// 개발자 도구에서 실행
location.reload(true);
```

#### B2. OPTIONS 요청 처리 오류
```
Method OPTIONS is not allowed
```

**해결 방법**:
```php
// secure-api-proxy.php에 추가
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}
```

### C. 요청 제한 문제

#### C1. 요청 제한 초과
```
Error: Rate limit exceeded. Please try again later.
```

**원인 분석**:
- 시간당 300회 제한 초과
- rate_limit.json 파일 문제
- 시간 윈도우 설정 오류

**해결 방법**:
1. **현재 사용량 확인**
```php
// 사용량 확인 스크립트
<?php
$data = json_decode(file_get_contents('rate_limit.json'), true);
$currentTime = time();
$hourAgo = $currentTime - 3600;

foreach ($data as $client => $requests) {
    $recentRequests = array_filter($requests, function($timestamp) use ($hourAgo) {
        return $timestamp > $hourAgo;
    });
    echo "Client: $client, Requests: " . count($recentRequests) . "\n";
}
?>
```

2. **제한 설정 조정**
```php
// rate-limiter.php 수정
public function __construct($storageFile = 'rate_limit.json', $maxRequests = 500, $timeWindow = 3600) {
    // 시간당 500회로 증가
}
```

3. **요청 제한 리셋**
```bash
rm rate_limit.json  # 파일 삭제로 리셋
```

#### C2. rate_limit.json 파일 오류
```
Warning: file_get_contents(rate_limit.json): failed to open stream
```

**해결 방법**:
1. **파일 권한 확인**
```bash
chmod 666 rate_limit.json
```

2. **디렉토리 권한 확인**
```bash
chmod 755 /public_html/
```

3. **파일 수동 생성**
```bash
echo '{}' > rate_limit.json
chmod 666 rate_limit.json
```

### D. PHP 관련 문제

#### D1. 클래스 로드 오류
```
Fatal error: Class 'RateLimiter' not found
```

**원인 분석**:
- rate-limiter.php 파일 누락
- require_once 경로 문제
- PHP 오토로드 문제

**해결 방법**:
1. **파일 존재 확인**
```bash
ls -la rate-limiter.php
```

2. **require_once 구문 확인**
```php
// secure-api-proxy.php 상단에 추가
require_once 'rate-limiter.php';
```

3. **절대 경로 사용**
```php
require_once __DIR__ . '/rate-limiter.php';
```

#### D2. PHP 메모리 부족
```
Fatal error: Allowed memory size exhausted
```

**해결 방법**:
1. **메모리 제한 증가**
```php
ini_set('memory_limit', '256M');
```

2. **.htaccess 설정**
```apache
php_value memory_limit 256M
```

#### D3. PHP 실행 시간 초과
```
Fatal error: Maximum execution time exceeded
```

**해결 방법**:
1. **실행 시간 제한 증가**
```php
ini_set('max_execution_time', 120);
```

2. **.htaccess 설정**
```apache
php_value max_execution_time 120
```

### E. 로깅 문제

#### E1. 로그 파일 생성 실패
```
Warning: file_put_contents(api_logs.txt): failed to open stream
```

**해결 방법**:
1. **파일 권한 설정**
```bash
touch api_logs.txt
chmod 666 api_logs.txt
```

2. **디렉토리 권한 확인**
```bash
chmod 755 /public_html/
```

3. **로그 디렉토리 생성**
```bash
mkdir logs
chmod 755 logs
chmod 666 logs/api_logs.txt
```

#### E2. 로그 파일 크기 문제
```
api_logs.txt 파일이 너무 큼
```

**해결 방법**:
1. **로그 로테이션 구현**
```php
function rotateLogFile($logFile, $maxSize = 10485760) { // 10MB
    if (file_exists($logFile) && filesize($logFile) > $maxSize) {
        rename($logFile, $logFile . '.' . date('Y-m-d-H-i-s'));
    }
}
```

2. **정기 로그 정리**
```bash
# cron job 설정
0 2 * * * find /public_html/ -name "api_logs.txt.*" -mtime +7 -delete
```

## 🔧 고급 문제 해결

### 1. 성능 최적화

#### 1.1 응답 시간 개선
```php
// 캐싱 구현
function getCachedResponse($cacheKey, $ttl = 3600) {
    $cacheFile = "cache/" . md5($cacheKey) . ".json";
    
    if (file_exists($cacheFile) && (time() - filemtime($cacheFile)) < $ttl) {
        return json_decode(file_get_contents($cacheFile), true);
    }
    
    return null;
}

function setCachedResponse($cacheKey, $response) {
    $cacheDir = "cache/";
    if (!is_dir($cacheDir)) {
        mkdir($cacheDir, 0755);
    }
    
    $cacheFile = $cacheDir . md5($cacheKey) . ".json";
    file_put_contents($cacheFile, json_encode($response));
}
```

#### 1.2 데이터베이스 연동
```php
// MySQL 연동으로 사용량 추적
class DatabaseRateLimiter {
    private $pdo;
    
    public function __construct($dsn, $username, $password) {
        $this->pdo = new PDO($dsn, $username, $password);
    }
    
    public function checkRateLimit($identifier) {
        $stmt = $this->pdo->prepare("
            SELECT COUNT(*) as request_count 
            FROM api_requests 
            WHERE client_id = ? AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
        ");
        $stmt->execute([$identifier]);
        $result = $stmt->fetch();
        
        return $result['request_count'] < 300;
    }
}
```

### 2. 보안 강화

#### 2.1 IP 화이트리스트
```php
function isAllowedIP($ip) {
    $allowedIPs = [
        '127.0.0.1',
        '192.168.1.0/24',
        // 허용된 IP 목록
    ];
    
    foreach ($allowedIPs as $allowedIP) {
        if (strpos($allowedIP, '/') !== false) {
            // CIDR 표기법 처리
            if (ipInRange($ip, $allowedIP)) {
                return true;
            }
        } else {
            if ($ip === $allowedIP) {
                return true;
            }
        }
    }
    
    return false;
}
```

#### 2.2 API 키 인증
```php
function validateClientAPIKey($providedKey) {
    $validKeys = [
        hash('sha256', 'client_secret_key_1'),
        hash('sha256', 'client_secret_key_2'),
    ];
    
    return in_array(hash('sha256', $providedKey), $validKeys);
}
```

### 3. 모니터링 강화

#### 3.1 실시간 알림 시스템
```php
function sendAlert($message, $level = 'WARNING') {
    // 이메일 알림
    $to = 'admin@edgeenglish.net';
    $subject = "[$level] API Server Alert";
    $body = "Time: " . date('Y-m-d H:i:s') . "\nMessage: $message";
    
    mail($to, $subject, $body);
    
    // 슬랙 알림 (선택사항)
    $slackWebhook = 'your_slack_webhook_url';
    $payload = json_encode(['text' => "[$level] $message"]);
    
    $ch = curl_init($slackWebhook);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $payload);
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_exec($ch);
    curl_close($ch);
}
```

#### 3.2 상세 통계 수집
```php
class APIAnalytics {
    private $pdo;
    
    public function recordRequest($clientId, $endpoint, $responseTime, $success) {
        $stmt = $this->pdo->prepare("
            INSERT INTO api_analytics 
            (client_id, endpoint, response_time, success, created_at) 
            VALUES (?, ?, ?, ?, NOW())
        ");
        $stmt->execute([$clientId, $endpoint, $responseTime, $success ? 1 : 0]);
    }
    
    public function getStatistics($days = 7) {
        $stmt = $this->pdo->prepare("
            SELECT 
                DATE(created_at) as date,
                COUNT(*) as total_requests,
                AVG(response_time) as avg_response_time,
                SUM(success) as successful_requests
            FROM api_analytics 
            WHERE created_at > DATE_SUB(NOW(), INTERVAL ? DAY)
            GROUP BY DATE(created_at)
            ORDER BY date DESC
        ");
        $stmt->execute([$days]);
        return $stmt->fetchAll();
    }
}
```

## 📞 지원 및 연락처

### 긴급 상황 대응
1. **서버 완전 다운**: 즉시 dothome.co.kr 고객지원 연락
2. **API Key 노출**: 즉시 OpenAI 지원팀 연락하여 키 비활성화
3. **보안 침해 의심**: 즉시 서버 접근 차단 및 조사

### 일반적인 지원 요청
- **기술적 문제**: 로그 파일과 함께 상세한 오류 메시지 제공
- **성능 문제**: 사용량 통계와 응답 시간 데이터 제공
- **설정 변경**: 현재 설정과 요청사항 명시

---

## 📚 추가 리소스

- [OpenAI API 문서](https://platform.openai.com/docs)
- [PHP 공식 문서](https://www.php.net/docs.php)
- [Apache .htaccess 가이드](https://httpd.apache.org/docs/current/howto/htaccess.html)
- [dothome.co.kr 고객지원](https://www.dothome.co.kr/)

**문제가 지속되거나 해결되지 않는 경우, 상세한 오류 로그와 함께 기술 지원을 요청하세요.** 🛠️
