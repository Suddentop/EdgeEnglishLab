# 유형#15 배포 후 에러 해결 가이드

## 🚨 문제 증상
- **개발 환경 (localhost)**: 정상 작동 ✅
- **배포 환경 (edgeenglish.net)**: CORS 에러 및 400/500 에러 발생 ❌

에러 메시지:
```
Access to fetch 'https://edgeenglish.net/php_api_proxy/api-proxy.php' 
from origin 'https://edgeenglish.net' has been blocked by CORS policy
```

---

## 🔍 문제 원인

### 1. 서버에 PHP 프록시 파일이 제대로 업로드되지 않음
### 2. 서버에서 OpenAI API 키 환경변수가 설정되지 않음
### 3. PHP 버전 또는 설정 문제

---

## ✅ 해결 방법

### 1단계: 프록시 서버 파일 확인

서버에 다음 파일들이 제대로 업로드되었는지 확인:

```
edgeenglish.net/
└── php_api_proxy/
    ├── api-proxy.php          ← 메인 프록시 파일
    ├── config.php             ← API 키 설정 파일
    ├── load-env.php           ← 환경변수 로더
    └── .env                   ← API 키가 저장된 파일 (중요!)
```

### 2단계: 서버의 `.env` 파일 설정 확인

**서버의 `php_api_proxy/.env` 파일**에 다음 내용이 있는지 확인:

```env
OPENAI_API_KEY=<YOUR_OPENAI_API_KEY>
```

⚠️ **중요**: 이 파일은 **서버에만** 존재해야 하며, 클라이언트 빌드에는 절대 포함되면 안 됩니다.

### 3단계: PHP 프록시 테스트

브라우저에서 직접 접속하여 테스트:

```
https://edgeenglish.net/php_api_proxy/api-proxy.php
```

**예상 결과**:
- ✅ 정상: `{"error":"Method not allowed"}` (GET 요청이라서 거부됨 - 정상)
- ❌ 404 Not Found: 파일이 업로드되지 않음
- ❌ 500 Internal Server Error: PHP 에러 발생
- ❌ API Key not configured: 환경변수 미설정

### 4단계: config.php 파일 확인

`php_api_proxy/config.php` 파일이 다음과 같이 설정되어 있는지 확인:

```php
<?php
// API Key 로드 (환경변수 또는 .env 파일에서)
$OPENAI_API_KEY = getenv('OPENAI_API_KEY');

// .env 파일에서 로드 (환경변수가 없는 경우)
if (!$OPENAI_API_KEY && file_exists(__DIR__ . '/.env')) {
    $envContent = file_get_contents(__DIR__ . '/.env');
    preg_match('/OPENAI_API_KEY=(.+)/', $envContent, $matches);
    if (isset($matches[1])) {
        $OPENAI_API_KEY = trim($matches[1]);
    }
}

return $OPENAI_API_KEY;
```

### 5단계: 파일 권한 확인

서버에서 PHP 파일들의 권한을 확인:

```bash
chmod 644 php_api_proxy/*.php
chmod 600 php_api_proxy/.env  # 보안을 위해 읽기 전용
```

---

## 🧪 테스트 방법

### 브라우저 개발자 도구에서 테스트

```javascript
fetch('https://edgeenglish.net/php_api_proxy/api-proxy.php', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    model: 'gpt-4o',
    messages: [{ role: 'user', content: 'Hello' }],
    max_tokens: 10
  })
})
.then(res => res.json())
.then(data => console.log('✅ 성공:', data))
.catch(err => console.error('❌ 에러:', err));
```

**예상 성공 응답**:
```json
{
  "choices": [{
    "message": {
      "content": "Hello! How can I..."
    }
  }]
}
```

---

## 🔧 추가 문제 해결

### CORS 에러가 계속 발생하는 경우

`api-proxy.php`의 CORS 헤더를 더 관대하게 변경:

```php
// 임시로 모든 Origin 허용 (테스트용)
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, GET, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization');
```

⚠️ **주의**: 프로덕션에서는 특정 도메인만 허용하도록 다시 변경해야 합니다.

### PHP 에러 로그 확인

서버에서 PHP 에러 로그를 확인:

```bash
# dothome.co.kr의 경우
tail -f ~/public_html/php_api_proxy/error.log
```

---

## 📝 체크리스트

배포 전 확인사항:

- [ ] `php_api_proxy/` 폴더가 서버에 업로드되었는가?
- [ ] `php_api_proxy/.env` 파일에 API 키가 설정되었는가?
- [ ] `api-proxy.php` 파일에 CORS 헤더가 설정되었는가?
- [ ] 브라우저에서 `api-proxy.php` 접근 시 404가 아닌가?
- [ ] 클라이언트 빌드에 API 키가 포함되지 않았는가?

---

## 🎯 최종 확인

1. **클라이언트 빌드 확인** (로컬):
```bash
cd D:\Dev\engquiz\build\static\js
findstr /C:"sk-proj" *.js
# 결과: 아무것도 나오지 않아야 함
```

2. **프록시 서버 확인** (브라우저):
```
https://edgeenglish.net/php_api_proxy/api-proxy.php
# 결과: {"error":"Method not allowed"} 또는 빈 응답 (정상)
```

3. **유형#15 테스트**:
- 이미지 업로드 후 "문제생성" 클릭
- 네트워크 탭에서 `api-proxy.php` 요청 확인
- 200 OK 응답이 와야 함

---

## 💡 추천 순서

1. 서버 FTP로 접속
2. `php_api_proxy/.env` 파일 확인 및 API 키 설정
3. 브라우저에서 `api-proxy.php` 직접 접근하여 404가 아닌지 확인
4. 개발자 도구 Network 탭에서 실제 요청/응답 확인
5. 문제가 계속되면 PHP 에러 로그 확인

문제가 해결되지 않으면 구체적인 에러 메시지와 함께 문의하세요!




