# 개발 환경 이미지 처리 설정 가이드

## 📅 작업 일시
2025-10-30

## 🎯 목표
**개발 서버(localhost:3000)에서 모든 유형의 "캡처화면 붙여넣기" 및 "이미지 파일 첨부" 기능이 정상 작동하도록 설정**

---

## 🔧 개발 환경 vs 프로덕션 환경

### 개발 환경 (Development)
- **URL**: `http://localhost:3000`
- **API 호출**: OpenAI API 직접 호출 (개발용 API 키 사용)
- **환경 파일**: `.env.local` (우선순위 높음)
- **목적**: 빠른 개발 및 테스트

### 프로덕션 환경 (Production)
- **URL**: `https://edgeenglish.net`
- **API 호출**: PHP 프록시 서버 경유 (보안)
- **환경 파일**: `.env.production.local` (빌드 시 사용)
- **목적**: 안전한 서비스 제공

---

## 📁 환경 파일 구조

### 파일 우선순위 (Create React App)
```
.env.local           > .env.production.local > .env > .env.development
```

### 1. `.env` (기본 설정)
**용도**: 프로덕션 기본 설정 + 모든 환경 공통 설정
```env
# PRODUCTION 환경 변수 설정
# https://edgeenglish.net 배포용

# Firebase 설정
REACT_APP_FIREBASE_API_KEY=AIzaSyDQJynQZGn3TomGEMtZYSGQrYlvO7CApNo
REACT_APP_FIREBASE_AUTH_DOMAIN=edgeenglishlab.firebaseapp.com
REACT_APP_FIREBASE_PROJECT_ID=edgeenglishlab
REACT_APP_FIREBASE_STORAGE_BUCKET=edgeenglishlab.firebasestorage.app
REACT_APP_FIREBASE_MESSAGING_SENDER_ID=13831715924
REACT_APP_FIREBASE_APP_ID=1:13831715924:web:41907bce49707865e981c1

# API 프록시 서버 URL (프로덕션 환경에서 사용)
REACT_APP_API_PROXY_URL=https://edgeenglish.net/php_api_proxy/api-proxy.php

# ⚠️ 중요: REACT_APP_OPENAI_API_KEY는 설정하지 마세요.
# 프로덕션에서는 반드시 프록시 서버를 통해서만 API 호출해야 합니다.
```

### 2. `.env.local` (개발 환경 전용) ⭐
**용도**: 로컬 개발 시 OpenAI API 직접 호출
**우선순위**: 가장 높음 (개발 서버 실행 시)
```env
# Development Environment Settings
# 개발 환경에서 로컬 테스트를 위해 API 키 사용 가능

# ⚠️ 개발 환경 전용: 로컬 테스트용으로만 사용
# 프로덕션 빌드 시에는 이 파일을 무시하고 .env.production.local을 사용합니다.
REACT_APP_OPENAI_API_KEY=<YOUR_OPENAI_API_KEY>

# Firebase 설정 (동일)
REACT_APP_FIREBASE_API_KEY=AIzaSyDQJynQZGn3TomGEMtZYSGQrYlvO7CApNo
REACT_APP_FIREBASE_AUTH_DOMAIN=edgeenglishlab.firebaseapp.com
REACT_APP_FIREBASE_PROJECT_ID=edgeenglishlab
REACT_APP_FIREBASE_STORAGE_BUCKET=edgeenglishlab.firebasestorage.app
REACT_APP_FIREBASE_MESSAGING_SENDER_ID=13831715924
REACT_APP_FIREBASE_APP_ID=1:13831715924:web:41907bce49707865e981c1
```

### 3. `.env.production.local` (프로덕션 빌드 전용)
**용도**: `npm run build` 실행 시 사용
```env
# 프로덕션 환경 전용 설정

# ⚠️ 주의: REACT_APP_OPENAI_API_KEY는 설정하지 마세요.
# 프록시 서버 URL (PHP 프록시)
REACT_APP_API_PROXY_URL=https://edgeenglish.net/php_api_proxy/api-proxy.php

# Firebase 설정 (동일)
REACT_APP_FIREBASE_API_KEY=AIzaSyDQJynQZGn3TomGEMtZYSGQrYlvO7CApNo
REACT_APP_FIREBASE_AUTH_DOMAIN=edgeenglishlab.firebaseapp.com
REACT_APP_FIREBASE_PROJECT_ID=edgeenglishlab
REACT_APP_FIREBASE_STORAGE_BUCKET=edgeenglishlab.firebasestorage.app
REACT_APP_FIREBASE_MESSAGING_SENDER_ID=13831715924
REACT_APP_FIREBASE_APP_ID=1:13831715924:web:41907bce49707865e981c1
```

### 4. `.env.local.dev` (백업 파일)
**용도**: `.env.local`의 백업 (수동 관리)
- 프로덕션 빌드 시 `.env.local`을 임시로 숨기고 싶을 때 사용
- 개발 재개 시 `.env.local`로 복사

---

## 🔄 작동 원리

### 개발 환경 (`npm start`)

```mermaid
개발 서버 실행
    ↓
.env.local 로드 (우선순위 1)
    ↓
REACT_APP_OPENAI_API_KEY 발견
    ↓
openaiProxyService.ts
    ↓
proxyUrl이 없으므로 → 직접 API 호출
    ↓
https://api.openai.com/v1/chat/completions
```

**코드 동작**:
```typescript
// openaiProxyService.ts
constructor() {
  this.proxyUrl = process.env.REACT_APP_API_PROXY_URL || 'https://edgeenglish.net/php_api_proxy/api-proxy.php';
}

async callOpenAI(request: OpenAIRequest) {
  if (this.proxyUrl) {
    // 프록시 서버 사용 (프로덕션)
    console.log('🤖 OpenAI 프록시 서버 호출 중...');
    response = await fetch(this.proxyUrl, { ... });
  } else {
    // 직접 호출 (개발)
    const apiKey = process.env.REACT_APP_OPENAI_API_KEY;
    console.log('🤖 OpenAI API 직접 호출 중... (개발 환경)');
    response = await fetch('https://api.openai.com/v1/chat/completions', {
      headers: { 'Authorization': `Bearer ${apiKey}` }
    });
  }
}
```

### 프로덕션 빌드 (`npm run build`)

```mermaid
빌드 시작
    ↓
.env.production.local 로드
    ↓
REACT_APP_API_PROXY_URL만 포함
    ↓
빌드 결과물
    ↓
프록시 URL만 하드코딩됨
```

---

## 🚀 개발 서버 실행 방법

### 1단계: 환경 파일 확인
```powershell
# 프로젝트 루트로 이동
cd D:\Dev\engquiz

# 환경 파일 확인
dir .env*
```

**필요한 파일**:
- ✅ `.env` - 기본 설정
- ✅ `.env.local` - 개발 환경 (API 키 포함)
- ✅ `.env.production.local` - 프로덕션 빌드용

### 2단계: 개발 서버 실행
```powershell
npm start
```

**예상 출력**:
```
Compiled successfully!

You can now view engquiz in the browser.

  Local:            http://localhost:3000
  On Your Network:  http://192.168.x.x:3000
```

### 3단계: 브라우저에서 확인
```
http://localhost:3000
```

---

## 🧪 테스트 방법

### 각 유형별 테스트 (20개)

#### Work #01 ~ #15
1. 해당 유형 선택
2. **캡처화면 붙여넣기** 테스트
   - 이미지 캡처 (Ctrl+C 또는 Print Screen)
   - 입력 영역에 Ctrl+V
   - "문제생성" 클릭
   - ✅ 정상: 텍스트 추출 + 문제 생성
3. **이미지 파일 첨부** 테스트
   - 파일 선택 또는 드래그앤드롭
   - "문제생성" 클릭
   - ✅ 정상: 텍스트 추출 + 문제 생성

#### Package #01 ~ #03
동일한 방법으로 테스트

### 개발자 도구 확인사항

#### Console 탭
```
✅ 정상:
🤖 OpenAI API 직접 호출 중... (개발 환경)
✅ 200 OK
✅ 문제 생성 완료

❌ 에러:
❌ API Key가 설정되지 않았습니다.
❌ 403 Forbidden (API 키 무효)
❌ 429 Too Many Requests (Rate Limit)
```

#### Network 탭
```
✅ 정상:
Request URL: https://api.openai.com/v1/chat/completions
Status: 200 OK
Response: { choices: [...] }

❌ 에러:
Status: 401 Unauthorized → API 키 문제
Status: 429 Too Many Requests → Rate Limit
Status: 500 Server Error → OpenAI 서버 문제
```

---

## ⚠️ 주의사항

### 1. 환경 파일 우선순위
```
npm start (개발)
  ↓
.env.local > .env (개발 API 키 사용)

npm run build (프로덕션)
  ↓
.env.production.local > .env (프록시 URL만 사용)
```

### 2. API 키 보안
- ✅ `.env.local`은 `.gitignore`에 포함됨 (커밋 안 됨)
- ✅ 개발 환경에서만 사용
- ❌ 절대 `.env`에 API 키 추가하지 말 것!

### 3. Rate Limiting
- OpenAI API 직접 호출 시 Rate Limit 주의
- 개발 시 과도한 요청 자제
- 필요 시 `setTimeout` 또는 디바운싱 추가

### 4. 캐시 문제
환경변수 변경 후 개발 서버 재시작 필요:
```powershell
# 서버 중지: Ctrl+C
npm start
```

---

## 🔧 문제 해결

### 문제 1: "API Key가 설정되지 않았습니다" 에러

**원인**: `.env.local` 파일이 없거나 API 키가 없음

**해결**:
```powershell
# .env.local 파일 확인
type .env.local

# 없으면 .env.local.dev에서 복사
Copy-Item .env.local.dev .env.local -Force

# 개발 서버 재시작
npm start
```

### 문제 2: "403 Forbidden" 에러

**원인**: API 키가 무효하거나 만료됨

**해결**:
1. OpenAI 계정 확인
2. API 키 재생성
3. `.env.local` 파일 업데이트
4. 개발 서버 재시작

### 문제 3: "CORS 에러"

**원인**: 개발 환경에서 프록시 서버 호출 시도

**해결**:
`.env.local` 파일에서 `REACT_APP_API_PROXY_URL` 제거:
```env
# ❌ 이 줄 제거 또는 주석 처리
# REACT_APP_API_PROXY_URL=https://edgeenglish.net/php_api_proxy/api-proxy.php
```

### 문제 4: 환경변수가 적용 안 됨

**원인**: 캐시 문제

**해결**:
```powershell
# node_modules 캐시 삭제
Remove-Item -Recurse -Force node_modules\.cache

# 개발 서버 재시작
npm start
```

### 문제 5: "429 Too Many Requests" 에러

**원인**: Rate Limit 초과

**해결**:
- 일정 시간 대기 (1-5분)
- 요청 빈도 줄이기
- OpenAI 계정의 Rate Limit 확인

---

## 📊 환경별 동작 비교

| 항목 | 개발 환경 (npm start) | 프로덕션 빌드 (npm run build) |
|------|----------------------|------------------------------|
| **환경 파일** | `.env.local` | `.env.production.local` |
| **API 키** | 포함 (직접 호출) | 미포함 (프록시 사용) |
| **프록시 URL** | 선택 사항 | 필수 |
| **API 호출** | OpenAI 직접 | PHP 프록시 경유 |
| **콘솔 메시지** | "직접 호출 중..." | "프록시 서버 호출 중..." |
| **속도** | 빠름 (직접 호출) | 중간 (프록시 경유) |
| **보안** | 로컬만 노출 | API 키 노출 없음 |

---

## 🎯 체크리스트

### 개발 환경 설정
- [x] `.env.local` 파일 존재 확인
- [x] `REACT_APP_OPENAI_API_KEY` 설정 확인
- [x] Firebase 설정 확인
- [x] 개발 서버 실행 성공

### 기능 테스트
- [ ] Work #01 캡처화면 붙여넣기
- [ ] Work #01 이미지 파일 첨부
- [ ] Work #02 ~ #15 (동일 테스트)
- [ ] Package #01 ~ #03 (동일 테스트)

### 콘솔 확인
- [ ] "🤖 OpenAI API 직접 호출 중... (개발 환경)" 메시지 확인
- [ ] Network 탭에서 `api.openai.com` 호출 확인
- [ ] 200 OK 응답 확인

---

## 📞 추가 지원

### 환경 파일 복원 스크립트
```powershell
# .env.local이 없을 경우 백업에서 복원
if (!(Test-Path .env.local)) {
  Copy-Item .env.local.dev .env.local -Force
  Write-Host "✅ .env.local 파일 복원 완료"
} else {
  Write-Host "✅ .env.local 파일이 이미 존재합니다"
}
```

### 환경 파일 전체 재생성
```powershell
# 모든 환경 파일 재생성 (백업 후)
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
Rename-Item .env ".env.backup_$timestamp" -ErrorAction SilentlyContinue

# 새로운 .env 파일 생성
# (내용은 위 섹션 참조)
```

---

## 🎉 결론

개발 환경 설정이 완료되었습니다!

**✅ 완료된 작업**:
1. `.env.local` 파일 복원 (API 키 포함)
2. 개발 서버 실행 준비 완료
3. 모든 유형(#01~#15, 패키지#01~#03) 테스트 가능

**📝 다음 단계**:
1. `npm start`로 개발 서버 실행
2. 각 유형별 이미지 처리 기능 테스트
3. 문제 발견 시 이 가이드의 "문제 해결" 섹션 참조

**🚀 프로덕션 배포 시**:
- `.env.local`은 무시됨 (개발 환경 전용)
- `.env.production.local`이 사용됨 (프록시 URL만 포함)
- API 키는 서버의 `.env` 파일에만 존재

모든 이미지 처리 기능이 개발 환경에서 정상 작동할 것입니다! 🎯




